
<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>نظام التسجيل الإلكتروني</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
  <style>
    :root {
      /* Light theme */
      --bg-gradient-light: linear-gradient(135deg, #f3f4f8, #ffffff);
      --card-bg-light: rgba(255, 255, 255, 0.95);
      --text-light: #1a202c;
      --primary-light: #4a6cf7;
      --secondary-light: #7b64ec;
      --accent-light: #00aeff;
      --success-light: #07bc0c;
      --error-light: #ff4d4f;
      --card-shadow-light: 0 10px 30px rgba(74, 108, 247, 0.15);
      --input-bg-light: rgba(255, 255, 255, 0.95);
      --input-border-light: rgba(203, 213, 224, 0.5);
      --backdrop-light: rgba(255, 255, 255, 0.8);
      --scrollbar-bg-light: rgba(255, 255, 255, 0.1);
      --scrollbar-thumb-light: rgba(74, 108, 247, 0.5);
      
      /* Active theme (defaults to light) */
      --bg-gradient: var(--bg-gradient-light);
      --card-bg: var(--card-bg-light);
      --text: var(--text-light);
      --primary: var(--primary-light);
      --secondary: var(--secondary-light);
      --accent: var(--accent-light);
      --success: var(--success-light);
      --error: var(--error-light);
      --card-shadow: var(--card-shadow-light);
      --input-bg: var(--input-bg-light);
      --input-border: var(--input-border-light);
      --backdrop: var(--backdrop-light);
      --scrollbar-bg: var(--scrollbar-bg-light);
      --scrollbar-thumb: var(--scrollbar-thumb-light);
    }
    
    [data-theme="dark"] {
      --bg-gradient: linear-gradient(135deg, #1e293b, #0f172a);
      --card-bg: rgba(30, 41, 59, 0.95);
      --text: #f8fafc;
      --primary: #7b64ec;
      --secondary: #4a6cf7;
      --accent: #38bdf8;
      --success: #22c55e;
      --error: #ef4444;
      --card-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      --input-bg: rgba(30, 41, 59, 0.9);
      --input-border: rgba(148, 163, 184, 0.2);
      --backdrop: rgba(15, 23, 42, 0.7);
      --scrollbar-bg: rgba(15, 23, 42, 0.2);
      --scrollbar-thumb: rgba(123, 100, 236, 0.5);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      transition: background-color 0.3s, color 0.3s, border-color 0.3s, box-shadow 0.3s;
    }

    html, body {
      height: 100%;
      scroll-behavior: smooth;
    }

    body {
      font-family: 'Cairo', sans-serif;
      background: var(--bg-gradient);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1.5rem;
      overflow-x: hidden;
      transition: background 0.5s;
    }

    .particles-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      opacity: 0.5;
      pointer-events: none;
    }

    .card {
      position: relative;
      background: var(--card-bg);
      backdrop-filter: blur(15px);
      border-radius: 1.5rem;
      padding: 2.5rem;
      width: 95%;
      max-height: 90vh;
      max-width: 600px;
      box-shadow: var(--card-shadow);
      overflow: hidden;
      z-index: 10;
      transform: translateY(0);
      animation: cardEntrance 1s ease-out forwards;
      border: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      flex-direction: column;
    }

    .card-content {
      overflow-y: auto;
      padding-right: 0.5rem;
      -ms-overflow-style: none;  /* IE and Edge */
      scrollbar-width: thin;  /* Firefox */
      flex: 1;
    }

    /* Designing the scrollbar */
    .card-content::-webkit-scrollbar {
      width: 8px;
    }

    .card-content::-webkit-scrollbar-track {
      background: var(--scrollbar-bg);
      border-radius: 10px;
      margin: 5px;
    }

    .card-content::-webkit-scrollbar-thumb {
      background: var(--scrollbar-thumb);
      border-radius: 10px;
      border: 2px solid transparent;
      background-clip: padding-box;
    }

    .card-content::-webkit-scrollbar-thumb:hover {
      background: var(--primary);
      border: 2px solid transparent;
      background-clip: padding-box;
    }

    .header-image {
      width: 100%;
      height: auto;
      max-height: 245px;
      margin: -2.5rem -2.5rem 1.5rem -2.5rem;
      width: calc(100% + 5rem);
      border-radius: 1.5rem 1.5rem 0 0;
      object-fit: cover;
    }

    @keyframes cardEntrance {
      from {
        opacity: 0;
        transform: translateY(25px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 5px;
      background: linear-gradient(90deg, var(--primary), var(--secondary), var(--accent));
      background-size: 300% 100%;
      animation: gradient 5s ease infinite;
    }

    @keyframes gradient {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .theme-toggle {
      position: absolute;
      top: 15px;
      left: 15px;
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 1.2rem;
      color: var(--text);
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      z-index: 100;
      transition: transform 0.3s;
      background-color: var(--card-bg);
      box-shadow: var(--card-shadow);
    }

    .theme-toggle:hover {
      transform: rotate(30deg);
    }

    h1, h2 {
      color: var(--primary);
      text-align: center;
      margin-bottom: 1.5rem;
      font-weight: 700;
    }

    h1 {
      font-size: 2rem;
    }

    h2 {
      font-size: 1.8rem;
    }

    .rank-label {
      text-align: center;
      font-size: 1.2rem;
      margin-bottom: 1rem;
      color: var(--accent);
      font-weight: 600;
    }

    .input-wrapper {
      position: relative;
      margin: 1.5rem 0;
    }

    .horizontal-fields {
      display: flex;
      gap: 10px;
      margin: 1.5rem 0;
    }

    .horizontal-fields .input-wrapper {
      margin: 0;
      flex: 1;
    }

    .form-input {
      width: 100%;
      padding: 1rem;
      padding-right: 2.5rem;
      border: 1px solid var(--input-border);
      border-radius: 1rem;
      background: var(--input-bg);
      color: var(--text);
      font-size: 1rem;
      font-family: 'Cairo', sans-serif;
      transition: all 0.3s ease;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(74, 108, 247, 0.2);
      transform: translateY(-2px);
    }

    .form-input:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      background-color: rgba(203, 213, 224, 0.3);
    }

    .input-icon {
      position: absolute;
      top: 50%;
      right: 12px;
      transform: translateY(-50%);
      color: var(--primary);
    }

    .file-input-container {
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin: 1.5rem 0;
    }

    .file-input-wrapper {
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      width: 100%;
      border: 2px dashed var(--input-border);
      border-radius: 1rem;
      padding: 1.5rem;
      text-align: center;
      transition: all 0.3s ease;
      background: var(--input-bg);
      cursor: pointer;
    }

    .file-input-wrapper:hover, .file-input-wrapper.dragover {
      border-color: var(--primary);
      background: var(--backdrop);
    }

    .file-input-wrapper input[type="file"] {
      position: absolute;
      top: 0;
      right: 0;
      min-width: 100%;
      min-height: 100%;
      opacity: 0;
      cursor: pointer;
    }

    .file-input-icon {
      margin: 0 auto 0.8rem;
      font-size: 3rem;
      color: var(--primary);
    }

    .file-input-text {
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: var(--text);
    }

    .file-input-info {
      font-size: 0.875rem;
      color: var(--text);
      opacity: 0.8;
      margin: 0.5rem 0;
    }

    .image-preview {
      max-width: 100%;
      max-height: 200px;
      border-radius: 0.5rem;
      box-shadow: var(--card-shadow);
      margin: 1rem auto;
      display: none;
    }

    .button {
      width: 100%;
      padding: 1rem;
      margin: 1rem 0;
      border: none;
      border-radius: 1rem;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      font-weight: 600;
      font-size: 1rem;
      font-family: 'Cairo', sans-serif;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      z-index: 1;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .button:hover {
      transform: translateY(-3px);
      box-shadow: 0 7px 14px rgba(0, 0, 0, 0.1), 0 3px 6px rgba(0, 0, 0, 0.1);
    }

    .button:active {
      transform: translateY(-1px);
    }

    .button::after {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, var(--secondary), var(--primary));
      z-index: -1;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .button:hover::after {
      opacity: 1;
    }

    .button:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .button:disabled::after {
      opacity: 0;
    }

    .button.success {
      background: linear-gradient(135deg, var(--success), #34d399);
    }

    .button.success::after {
      background: linear-gradient(135deg, #34d399, var(--success));
    }

    .error-message {
      color: var(--error);
      font-size: 1.2rem;
      margin-top: 0.5rem;
      display: none;
      animation: fadeIn 0.3s ease;
      text-align: center;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .loader {
      display: none;
      text-align: center;
      margin: 1rem 0;
    }

    .loader-spinner {
      display: inline-block;
      width: 35px;
      height: 35px;
      border: 4px solid rgba(74, 108, 247, 0.2);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .progress-container {
      display: none;
      margin: 1.5rem 0;
    }

    .progress-bar {
      height: 10px;
      background: rgba(160, 174, 192, 0.3);
      border-radius: 999px;
      overflow: hidden;
      position: relative;
    }

    .progress-fill {
      height: 100%;
      width: 0;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      border-radius: 999px;
      transition: width 0.3s;
      position: relative;
    }

    .progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(
        90deg,
        transparent,
        rgba(255, 255, 255, 0.3),
        transparent
      );
      animation: progressShimmer 2s infinite;
    }

    @keyframes progressShimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    
    .progress-text {
      text-align: center;
      margin-top: 0.5rem;
      font-size: 0.9rem;
      color: var(--text);
      font-weight: 600;
      opacity: 0.9;
    }

    .progress-wisdom {
      text-align: center;
      margin-top: 0.5rem;
      font-size: 1rem;
      color: var(--accent);
      font-style: italic;
      font-weight: 500;
      opacity: 0.9;
      min-height: 1.5rem;
    }

    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      color: white;
      font-weight: 600;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      z-index: 999;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 250px;
      text-align: center;
      align-content: center;
      flex-wrap: nowrap;
      height: 70px;
      opacity: 0;
      transition: transform 0.5s ease, opacity 0.5s ease;
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    .toast.success {
      background: var(--success);
    }

    .toast.error {
      background: var(--error);
    }

    .toast-icon {
      margin-left: 0.5rem;
      font-size: 1.1rem;
      height: 25px;
      width: 25px;
    }
    
    .toast.success .toast-icon {
      color: #ffffff;
    }
    
    .toast.error .toast-icon {
      color: #ffffff;
    }
    
    .toast-icon {
      fill: none;
      stroke: currentcolor;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    .result-section {
      text-align: center;
    }

    .success-icon {
      font-size: 4rem;
      color: var(--success);
      margin-bottom: 1rem;
      display: inline-block;
      animation: bounce 1s ease-in-out;
    }

    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-20px); }
      60% { transform: translateY(-10px); }
    }

    .radio-group {
      display: flex;
      justify-content: space-evenly;
      margin: 1rem 0;
    }

    .radio-option {
      position: relative;
      display: flex;
      align-items: center;
      cursor: pointer;
    }

    .radio-option input {
      position: absolute;
      opacity: 0;
      cursor: pointer;
    }

    .radio-custom {
      position: relative;
      display: inline-block;
      width: 20px;
      height: 20px;
      margin-left: 0.5rem;
      border: 2px solid var(--primary);
      border-radius: 50%;
    }

    .radio-option:hover .radio-custom {
      border-color: var(--secondary);
    }

    .radio-option input:checked ~ .radio-custom:after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--primary);
    }

    .tabs {
      display: flex;
      flex-wrap: wrap;
      margin: 0.5rem 0;
      padding: 0.5rem;
      border-radius: 0.75rem;
      background-color: var(--backdrop);
    }
    
    .tab-button {
      padding: 0.75rem 1.25rem;
      border: none;
      background: transparent;
      color: var(--text);
      font-family: 'Cairo', sans-serif;
      font-weight: 600;
      font-size: 0.9rem;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: all 0.3s;
      flex: 1;
      text-align: center;
      margin: 0 0.25rem;
      position: relative;
    }
    
    .tab-button.active {
      background: var(--primary);
      color: white;
      box-shadow: 0 4px 12px rgba(74, 108, 247, 0.3);
    }
    
    .tab-content {
      display: none;
      padding: 1.5rem;
      border-radius: 0.75rem;
      background: var(--card-bg);
      box-shadow: var(--card-shadow);
      margin: 0.5rem 0 1.5rem;
      transition: all 0.3s;
      animation: fadeIn 0.3s ease;
    }
    
    .tab-content.active {
      display: block;
    }

    .pdf-preview {
      width: 100%;
      text-align: center;
    }
    
    .pdf-preview-title {
      font-weight: 600;
      margin-bottom: 0.75rem;
      color: var(--primary);
      font-size: 1.1rem;
    }
    
    .pdf-container {
      position: relative;
      width: 100%;
      height: 0;
      padding-bottom: 120%;
      overflow: hidden;
      border-radius: 0.75rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      margin-bottom: 1rem;
    }
    
    .pdf-frame {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: none;
      background: #f8f9fa;
    }
    
    .download-button {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0.75rem 1.5rem;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      border: none;
      border-radius: 0.5rem;
      font-family: 'Cairo', sans-serif;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      text-decoration: none;
      width: 100%;
      box-shadow: 0 4px 12px rgba(74, 108, 247, 0.2);
    }
    
    .download-button svg {
      margin-left: 0.5rem;
    }
    
    .download-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(74, 108, 247, 0.3);
    }

    .history-section {
      margin-top: 2rem;
      padding-top: 0.5rem;
      border-top: 1px solid var(--input-border);
    }
    
    .history-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 0;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .history-title {
      font-weight: 600;
      color: var(--primary);
      font-size: 1.1rem;
      margin: 0;
    }
    
    .history-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.5s ease;
    }
    
    .history-content.open {
      max-height: 1000px;
      margin-top: 0.5rem;
    }
    
    .history-item {
      margin-bottom: 1rem;
      padding: 1rem;
      border-radius: 0.75rem;
      background: var(--backdrop);
      box-shadow: var(--card-shadow);
      animation: fadeIn 0.3s;
    }
    
    .history-date {
      font-weight: 600;
      margin-bottom: 0.75rem;
      color: var(--accent);
      text-align: center;
      font-size: 0.9rem;
    }
    
    .history-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 0.5rem;
    }
    
    .history-button {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0.5rem;
      border-radius: 0.5rem;
      background: var(--card-bg);
      color: var(--text);
      font-weight: 600;
      font-size: 0.85rem;
      border: 1px solid var(--input-border);
      cursor: pointer;
      transition: all 0.3s;
      text-decoration: none;
    }
    
    .history-button:hover {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    .chevron-icon {
      transition: transform 0.3s;
    }
    
    .rotate-180 {
      transform: rotate(180deg);
    }

    /* Responsive Styles */
    @media (max-width: 576px) {
      .card {
        padding: 1.5rem;
        margin-bottom: 1rem;
        width: 95%;
        max-height: 95vh;
      }
      
      .header-image {
        margin: -1.5rem -1.5rem 1.5rem -1.5rem;
        width: calc(100% + 3rem);
      }
      
      h1 {
        font-size: 1.5rem;
      }
      
      h2 {
        font-size: 1.3rem;
      }
      
      .tab-button {
        padding: 0.5rem;
        font-size: 0.85rem;
      }
      
      .tab-content {
        padding: 1rem;
      }
      
      .pdf-container {
        padding-bottom: 140%;
      }

      .horizontal-fields {
        flex-direction: column;
        gap: 1rem;
      }

      .horizontal-fields .input-wrapper {
        margin: 0;
      }
    }

    @media (max-width: 400px) {
      .card {
        padding: 1rem;
      }
      
      .header-image {
        margin: -1rem -1rem 1rem -1rem;
        width: calc(100% + 2rem);
      }
      
      .form-input {
        font-size: 0.9rem;
      }
      
      .radio-group {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }

      .file-input-wrapper {
        padding: 1rem;
      }

      .file-input-icon {
        font-size: 2rem;
      }
    }
    
    /* Accessibility */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border-width: 0;
    }
    
    /* Animations for page transitions */
    .section {
      transition: all 0.5s ease-in-out;
    }
    
    .section.hidden {
      opacity: 0;
      transform: translateY(20px);
      pointer-events: none;
      position: absolute;
      display: none;
    }
    
    .section.visible {
      opacity: 1;
      transform: translateY(0);
    }
    
    /* Blur effect for disabled content */
    .blur-content {
      filter: blur(3px);
      pointer-events: none;
      user-select: none;
      transition: filter 0.3s ease;
    }

    /* Pulsating effect for loader */
    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.05); opacity: 0.8; }
      100% { transform: scale(1); opacity: 1; }
    }

    .pulse {
      animation: pulse 1.5s ease-in-out infinite;
    }
  </style>
</head>
<body>
  <div class="particles-container" id="particles-js"></div>
  
  <button id="themeToggle" class="theme-toggle" aria-label="Toggle dark/light mode">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" id="themeIcon">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </button>
  
  <div class="card">
    <!-- Header Image -->
    <img src="https://i.ibb.co/sJXfcDHM/3a4c72ac-fd79-4a6f-86d8-96031eec8209.jpg" alt="شعار المنظمة" class="header-image">
    
    <div class="card-content">
      <!-- قسم المفتاح -->
      <div id="keySection" class="section visible">
        <h1>مرحبًا بك في نظام التسجيل</h1>
        <div class="input-wrapper">
          <input type="text" class="form-input" id="accessKey" placeholder="أدخل مفتاح الوصول">
          <span class="input-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"></path>
            </svg>
          </span>
        </div>
        <div id="errorMsg" class="error-message">المفتاح غير صحيح، حاول مرة أخرى.</div>
        <button id="validateKeyBtn" class="button">
          تأكيد المفتاح
        </button>
        <div id="loader" class="loader">
          <div class="loader-spinner"></div>
          <p id="loaderText">جاري التحقق...</p>
        </div>
        <div id="progressBarContainer" class="progress-container">
          <div class="progress-bar">
            <div id="validateProgressFill" class="progress-fill"></div>
          </div>
          <div class="progress-text" id="validateProgressText">جاري التحقق من المفتاح...</div>
          <div class="progress-wisdom" id="validateProgressWisdom"></div>
        </div>
      </div>

      <!-- قسم النموذج -->
      <div id="formSection" class="section hidden">
        <h2>استمارة التسجيل</h2>
        <div id="rankLabel" class="rank-label"></div>
        
        <div class="input-wrapper">
          <input type="text" class="form-input" id="fullName" placeholder="الاسم الثلاثي">
          <span class="input-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
          </span>
        </div>
        
        <!-- حقول إضافية للقائد والكشاف في نفس السطر -->
        <div id="additionalFieldsSection" style="display: none;">
          <div class="horizontal-fields">
            <div class="input-wrapper">
              <input type="text" class="form-input" id="teamNumber" placeholder="رقم الفرقة">
              <span class="input-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                  <circle cx="8.5" cy="7" r="4"></circle>
                  <polyline points="17 11 19 13 23 9"></polyline>
                </svg>
              </span>
            </div>
            
            <div class="input-wrapper">
              <input type="text" class="form-input" id="serialNumber" placeholder="الرقم التسلسلي">
              <span class="input-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <line x1="4" y1="9" x2="20" y2="9"></line>
                  <line x1="4" y1="15" x2="20" y2="15"></line>
                  <line x1="10" y1="3" x2="8" y2="21"></line>
                  <line x1="16" y1="3" x2="14" y2="21"></line>
                </svg>
              </span>
            </div>
          </div>
        </div>
        
        <!-- اختيار النوع للقادة -->
        <div id="leaderTypeSection" class="radio-group" style="display: none;">
          <label class="radio-option">
            <input type="radio" name="leaderType" value="القائد الكشفي" checked>
            <span class="radio-custom"></span>
            القائد الكشفي
          </label>
          <label class="radio-option">
            <input type="radio" name="leaderType" value="القائدة الكشفية">
              <span class="radio-custom"></span>
            القائدة الكشفية
          </label>
        </div>
        
        <!-- حقل الصورة للقائد والكشاف مع المعاينة -->
        <div id="photoSection" style="display: none;">
          <div class="file-input-container">
            <div class="file-input-wrapper" id="dropArea">
              <div class="file-input-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                  <circle cx="8.5" cy="8.5" r="1.5"></circle>
                  <polyline points="21 15 16 10 5 21"></polyline>
                </svg>
              </div>
              <div class="file-input-text">اختر صورة شخصية</div>
              <div class="file-input-info">
                الحد الأقصى للملف 20 ميجا <br> الصيغ المسموحة: JPG و PNG
              </div>
              <img id="previewImg" src="" alt="معاينة الصورة" class="image-preview">
              <input type="file" accept=".jpg, .jpeg, .png" id="photoUpload" class="form-input" aria-label="حمل صورة شخصية">
            </div>
          </div>
        </div>
        
        <div id="formProgressContainer" class="progress-container">
          <div class="progress-bar">
            <div id="progressFill" class="progress-fill"></div>
          </div>
          <div class="progress-text" id="progressText">جاري تحميل البيانات...</div>
          <div class="progress-wisdom" id="progressWisdom"></div>
        </div>
        
        <div id="submitError" class="error-message"></div>
        
        <button id="submitFormBtn" class="button success">
          إرسال البيانات
        </button>

        <!-- سجل الملفات السابقة للقادة -->
        <div id="fileHistorySection" class="history-section" style="display: none;">
          <div class="history-header" id="historyHeader">
            <h3 class="history-title">سجل الملفات السابقة</h3>
            <div class="chevron-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </div>
          </div>
          <div id="historyContent" class="history-content">
            <div id="historyItems"></div>
          </div>
        </div>
      </div>

      <!-- قسم النتائج -->
      <div id="resultSection" class="section hidden result-section">
        <div class="success-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
          </svg>
        </div>
        <h2>تمت العملية بنجاح! 🎉</h2>
        <p>تم إنشاء المستندات الخاصة بك، يمكنك معاينتها وتحميلها الآن</p>
        
        <!-- معاينة ملفات PDF - Tabs -->
        <div id="pdfTabs" class="tabs"></div>
        <div id="pdfTabContents"></div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">
    <span class="toast-icon"></span>
    <span id="toastMessage"></span>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
  <script>
    // ========== إعداد الواجهة ==========
    document.addEventListener('DOMContentLoaded', function() {
      // متغيرات عامة للتخزين المؤقت
      let currentKey = '';
      let currentRank = '';
      let currentUsed = '';
      let isProcessing = false;
      let wasSubmitted = false;

      // ========== المصفوفة الحكم والنصائح ==========
      const wisdomMessages = [
        "الصبر مفتاح الفرج",
        "التأني من الرحمن والعجلة من الشيطان",
        "أطلب العلم من المهد إلى اللحد",
        "خير الأمور أوسطها",
        "من جد وجد ومن زرع حصد",
        "قليل دائم خير من كثير منقطع",
        "تعلم فليس المرء يولد عالماً",
        "العلم نور والجهل ظلام",
        "من علم علم ومن جهل قال لا أعلم",
        "إذا تم العقل نقص الكلام",
        "لكل مجتهد نصيب",
        "رب ضارة نافعة",
        "اصبر على ما تكره فربما كان خيراً لك",
        "شاور من هو أكبر منك سناً وأكثر منك تجربة",
        "العلم في الصغر كالنقش على الحجر"
      ];

      // إعداد الجزيئات
      particlesJS('particles-js', {
        particles: {
          number: { value: 80, density: { enable: true, value_area: 800 } },
          color: { value: '#4a6cf7' },
          shape: { type: 'circle' },
          opacity: { value: 0.5, random: false },
          size: { value: 3, random: true },
          line_linked: {
            enable: true,
            distance: 150,
            color: '#4a6cf7',
            opacity: 0.4,
            width: 1
          },
          move: {
            enable: true,
            speed: 2,
            direction: 'none',
            random: false,
            straight: false,
            out_mode: 'out',
            bounce: false
          }
        },
        interactivity: {
          detect_on: 'canvas',
          events: {
            onhover: { enable: true, mode: 'grab' },
            onclick: { enable: true, mode: 'push' },
            resize: true
          },
          modes: {
            grab: { distance: 140, line_linked: { opacity: 1 } },
            push: { particles_nb: 4 }
          }
        },
        retina_detect: true
      });

      // تبديل السمة (الضوء/الظلام)
      const themeToggleBtn = document.getElementById('themeToggle');
      const themeIcon = document.getElementById('themeIcon');
      const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
      
      // تعيين السمة الافتراضية بناءً على تفضيلات المستخدم
      if (prefersDarkScheme.matches) {
        document.body.setAttribute('data-theme', 'dark');
        updateThemeIcon('dark');
      } else {
        document.body.setAttribute('data-theme', 'light');
        updateThemeIcon('light');
      }
      
      // زر تبديل السمة
      themeToggleBtn.addEventListener('click', () => {
        const currentTheme = document.body.getAttribute('data-theme');
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        
        document.body.setAttribute('data-theme', newTheme);
        updateThemeIcon(newTheme);
        
        // تحديث لون الجزيئات حسب السمة
        updateParticlesColor(newTheme);
      });
      
      // تحديث أيقونة السمة
      function updateThemeIcon(theme) {
        if (theme === 'dark') {
          themeIcon.innerHTML = `<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>`;
        } else {
          themeIcon.innerHTML = `
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
          `;
        }
      }
      
      // تحديث لون الجزيئات
      function updateParticlesColor(theme) {
        const color = theme === 'dark' ? '#7b64ec' : '#4a6cf7';
        if (window.pJSDom && window.pJSDom[0]) {
          window.pJSDom[0].pJS.particles.array.forEach(particle => {
            particle.color.value = color;
          });
          window.pJSDom[0].pJS.particles.line_linked.color = color;
        }
      }
      
      // معاينة الصورة
      const photoUpload = document.getElementById('photoUpload');
      const previewImg = document.getElementById('previewImg');
      const dropArea = document.getElementById('dropArea');
      
      photoUpload.addEventListener('change', function() {
        if (this.files && this.files[0]) {
          const reader = new FileReader();
          
          reader.onload = function(e) {
            previewImg.src = e.target.result;
            previewImg.style.display = 'block';
            
            // تحريك التأثير
            previewImg.style.opacity = '0';
            setTimeout(() => {
              previewImg.style.opacity = '1';
              previewImg.style.transition = 'opacity 0.5s';
            }, 10);
          };
          
          reader.readAsDataURL(this.files[0]);
        }
      });
      
      // مربع السحب والإفلات للصور
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, preventDefaults, false);
      });
      
      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }
      
      ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, () => {
          dropArea.classList.add('dragover');
        }, false);
      });
      
      ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, () => {
          dropArea.classList.remove('dragover');
        }, false);
      });
      
      dropArea.addEventListener('drop', e => {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        if (files && files.length) {
          photoUpload.files = files;
          const event = new Event('change', { bubbles: true });
          photoUpload.dispatchEvent(event);
        }
      });
      
      // تبديل بين الأقسام
      const sections = {
        key: document.getElementById('keySection'),
        form: document.getElementById('formSection'),
        result: document.getElementById('resultSection')
      };
      
      function showSection(sectionId) {
        // منع تغيير الأقسام أثناء المعالجة
        if (isProcessing) {
          return;
        }
        
        // تأكيد صالحية الانتقال بين الصفحات
        if (sectionId === 'form' && !currentKey) {
          // إذا حاول المستخدم الوصول إلى صفحة النموذج بدون مفتاح صالح
          showToast('غير مصرح بالوصول المباشر', 'error');
          window.location.reload();
          return;
        }
        
        if (sectionId === 'result' && !currentKey) {
          // إذا حاول المستخدم الوصول إلى صفحة النتائج بدون مفتاح صالح
          showToast('غير مصرح بالوصول المباشر', 'error');
          window.location.reload();
          return;
        }
        
        // تخزين الصفحة الحالية في ذاكرة الجلسة
        sessionStorage.setItem('currentSection', sectionId);
        
        Object.keys(sections).forEach(key => {
          if (key === sectionId) {
            sections[key].classList.remove('hidden');
            sections[key].classList.add('visible');
            
            // إضافة خاصية البيانات للمساعدة في تحديد القسم الحالي
            sections[key].dataset.active = 'true';
          } else {
            sections[key].classList.remove('visible');
            sections[key].classList.add('hidden');
            
            // إزالة خاصية البيانات من الأقسام غير النشطة
            sections[key].dataset.active = 'false';
          }
        });
        
        // إضافة مراقب للتغييرات على DOM للتأكد من عدم التلاعب بالأقسام
        if (!window._sectionObserver) {
          window._sectionObserver = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
              if (mutation.type === 'attributes' && 
                  (mutation.attributeName === 'class' || mutation.attributeName === 'style')) {
                const el = mutation.target;
                if (el.classList.contains('section') && el.dataset.active === 'false' && 
                    !el.classList.contains('hidden')) {
                  // إعادة تطبيق الإخفاء إذا تم العبث بالفصل
                  el.classList.add('hidden');
                  el.classList.remove('visible');
                  console.warn('محاولة وصول غير مصرح بها');
                }
              }
            });
          });
          
          // تطبيق المراقب على جميع الأقسام
          Object.values(sections).forEach(section => {
            window._sectionObserver.observe(section, { 
              attributes: true, 
              attributeFilter: ['class', 'style'] 
            });
          });
        }
      }
      
      // ربط الأزرار
      document.getElementById('validateKeyBtn').addEventListener('click', validateKey);
      document.getElementById('submitFormBtn').addEventListener('click', submitForm);
      
      // إضافة تبديل لقسم التاريخ
      const historyHeader = document.getElementById('historyHeader');
      const historyContent = document.getElementById('historyContent');
      const chevronIcon = document.querySelector('.chevron-icon svg');
      
      historyHeader && historyHeader.addEventListener('click', function() {
        historyContent.classList.toggle('open');
        chevronIcon.classList.toggle('rotate-180');
      });
      
      // ========== دوال مساعدة ==========
      
      // دالة لعرض رسالة حكمة بشكل عشوائي
      function showRandomWisdom(element) {
        const randomIndex = Math.floor(Math.random() * wisdomMessages.length);
        element.textContent = wisdomMessages[randomIndex];
        element.classList.add('pulse');
        
        // تغيير الحكمة كل 5 ثوان
        return setInterval(() => {
          const newIndex = Math.floor(Math.random() * wisdomMessages.length);
          element.textContent = wisdomMessages[newIndex];
        }, 5000);
      }
      
      // دالة لتحديث شريط التقدم تدريجياً
      function updateProgressBar(progressElement, textElement, wisdomElement, steps) {
        let currentStep = 0;
        let intervalId = null;
        let wisdomIntervalId = null;
        
        // عرض عبارة حكمة عشوائية
        wisdomIntervalId = showRandomWisdom(wisdomElement);
        
        // وظيفة لتحديث شريط التقدم بشكل متدرج
        function updateProgress() {
          if (currentStep < steps.length) {
            const step = steps[currentStep];
            progressElement.style.width = step.progress + '%';
            textElement.textContent = step.text;
            currentStep++;
          } else {
            clearInterval(intervalId);
          }
        }
        
        // بدء تحديث شريط التقدم
        intervalId = setInterval(updateProgress, 800);
        updateProgress(); // تحديث فوري للخطوة الأولى
        
        // إرجاع الدوال لإيقاف التحديثات
        return {
          completeProgress: function(finalText) {
            clearInterval(intervalId);
            clearInterval(wisdomIntervalId);
            progressElement.style.width = '100%';
            textElement.textContent = finalText || 'تمت العملية بنجاح';
            wisdomElement.textContent = '';
            wisdomElement.classList.remove('pulse');
          },
          stopProgress: function() {
            clearInterval(intervalId);
            clearInterval(wisdomIntervalId);
            wisdomElement.classList.remove('pulse');
          }
        };
      }
      
      // ========== دوال التحقق والإرسال ==========
      
      // دالة التحقق من المفتاح
      function validateKey() {
        // التحقق من أن العملية ليست قيد التنفيذ بالفعل
        if (isProcessing) {
          return;
        }
        
        const keyInput = document.getElementById('accessKey');
        const errMsg = document.getElementById('errorMsg');
        const loader = document.getElementById('loader');
        const validateBtn = document.getElementById('validateKeyBtn');
        const progressContainer = document.getElementById('progressBarContainer');
        const progressFill = document.getElementById('validateProgressFill');
        const progressText = document.getElementById('validateProgressText');
        const progressWisdom = document.getElementById('validateProgressWisdom');
        
        // تنظيف المدخلات
        const key = keyInput.value.trim();
        currentKey = key; // تخزين المفتاح للاستخدام اللاحق
        errMsg.style.display = 'none';
        
        if (!key) {
          errMsg.textContent = 'الرجاء إدخال مفتاح وصول صحيح';
          errMsg.style.display = 'block';
          keyInput.focus();
          return;
        }
        
        // تعيين حالة المعالجة
        isProcessing = true;
        
        // تعطيل حقل الإدخال وزر التأكيد أثناء عملية التحقق
        keyInput.disabled = true;
        validateBtn.disabled = true;
        
        // عرض شريط التقدم مع الرسائل المتغيرة
        progressContainer.style.display = 'block';
        
        // تحديث شريط التقدم تدريجياً
        const progressUpdater = updateProgressBar(progressFill, progressText, progressWisdom, [
          { progress: 20, text: 'جاري التحقق من المفتاح...' },
          { progress: 40, text: 'جاري البحث في قاعدة البيانات...' },
          { progress: 60, text: 'جاري التحقق من الصلاحيات...' },
          { progress: 80, text: 'جاري تحضير النموذج...' }
        ]);
        
        google.script.run
          .withSuccessHandler(function(response) {
            // إيقاف حالة المعالجة
            isProcessing = false;
            
            // إكمال شريط التقدم
            progressUpdater.completeProgress('تم التحقق بنجاح');
            
            // إخفاء شريط التقدم بعد فترة قصيرة
            setTimeout(() => {
              progressContainer.style.display = 'none';
            }, 1000);
            
            // في حالة نجاح التحقق
            if (response.isValid) {
              // تخزين معلومات المفتاح
              currentRank = response.rank;
              currentUsed = response.used;
              
              // إذا كان المفتاح مستخدم (ليس قائد) فنحول المستخدم مباشرة إلى صفحة النتائج
              if (response.used && response.rank !== 'قائد' && response.canAddNewRecord === false) {
                showPreviousResults(key);
                return;
              }
              
              // تهيئة صفحة النموذج بناءً على الرتبة
              setupFormBasedOnRank(response.rank, response.used);
              
              // التحقق من وجود ملفات سابقة للقادة
              if (response.previousFiles && response.previousFiles.length > 0) {
                loadPreviousFiles(response.previousFiles);
              }
              
              // الانتقال إلى صفحة النموذج
              showSection('form');
            } else {
              errMsg.textContent = 'المفتاح غير صحيح، الرجاء المحاولة مرة أخرى';
              errMsg.style.display = 'block';
              keyInput.disabled = false;
              validateBtn.disabled = false;
              keyInput.focus();
              // انيميشن اهتزاز للمدخل
              keyInput.classList.add('shake');
              setTimeout(() => keyInput.classList.remove('shake'), 500);
            }
          })
          .withFailureHandler(function(error) {
            // إيقاف حالة المعالجة
            isProcessing = false;
            
            // إيقاف تحديث شريط التقدم
            progressUpdater.stopProgress();
            
            // إخفاء شريط التقدم
            progressContainer.style.display = 'none';
            
            validateBtn.disabled = false;
            keyInput.disabled = false;
            
            errMsg.textContent = error || 'حدث خطأ في الخادم، الرجاء المحاولة لاحقًا';
            errMsg.style.display = 'block';
          })
          .validateKey(key);
      }
      
      // إعداد صفحة النموذج بناءً على الرتبة
      function setupFormBasedOnRank(rank, used) {
        const rankLabel = document.getElementById('rankLabel');
        const leaderTypeSection = document.getElementById('leaderTypeSection');
        const photoSection = document.getElementById('photoSection');
        const additionalFieldsSection = document.getElementById('additionalFieldsSection');
        const fileHistorySection = document.getElementById('fileHistorySection');
        
        // إعادة تعيين جميع العناصر
        photoSection.style.display = 'none';
        leaderTypeSection.style.display = 'none';
        additionalFieldsSection.style.display = 'none';
        fileHistorySection.style.display = 'none';
        
        // تعيين عنوان الرتبة والحقول المظهرة
        switch (rank) {
          case 'قائد':
            rankLabel.textContent = 'القائد الكشفي - القائدة الكشفية';
            leaderTypeSection.style.display = 'flex';
            photoSection.style.display = 'block';
            additionalFieldsSection.style.display = 'block';
            fileHistorySection.style.display = 'block';
            break;
          case 'لجان':
            rankLabel.textContent = 'لجان التميز التنفيذي';
            // لا داعي للصورة أو الحقول الإضافية
            break;
          case 'كشاف':
            rankLabel.textContent = 'الكشاف - فتاة الكشافة';
            photoSection.style.display = 'block';
            additionalFieldsSection.style.display = 'block';
            break;
          default:
            rankLabel.textContent = '';
        }
      }
      
      // تحميل الملفات السابقة
      function loadPreviousFiles(files) {
        const historySection = document.getElementById('fileHistorySection');
        const historyItems = document.getElementById('historyItems');
        
        if (files && files.length > 0) {
          historySection.style.display = 'block';
          historyItems.innerHTML = ''; // مسح المحتوى السابق
          
          // إضافة كل مجموعة ملفات بشكل منفصل
          files.forEach(file => {
            // إنشاء عنصر للتاريخ
            const historyItem = document.createElement('div');
            historyItem.className = 'history-item';
            
            // عنوان التاريخ والاسم
            const dateHeader = document.createElement('div');
            dateHeader.className = 'history-date';
            dateHeader.textContent = `${file.name} - ${file.date}`;
            historyItem.appendChild(dateHeader);
            
            // حاوية الأزرار
            const buttonsContainer = document.createElement('div');
            buttonsContainer.className = 'history-buttons';
            
            // التحقق من وجود كل ملف على حدة وإضافة أزرار التحميل المناسبة
            let hasPdfs = false;
            
            if (file.pdf1) {
              hasPdfs = true;
              const button = createHistoryButton(file.pdf1, 'الشهادة');
              buttonsContainer.appendChild(button);
            }
            
            if (file.pdf2) {
              hasPdfs = true;
              const button = createHistoryButton(file.pdf2, 'البطاقة');
              buttonsContainer.appendChild(button);
            }
            
            if (file.pdf3) {
              hasPdfs = true;
              const button = createHistoryButton(file.pdf3, 'الكتيب');
              buttonsContainer.appendChild(button);
            }
            
            // إضافة الأزرار فقط إذا كان هناك ملف PDF واحد على الأقل
            if (hasPdfs) {
              historyItem.appendChild(buttonsContainer);
              historyItems.appendChild(historyItem);
            }
          });
          
          // إذا لم يتم إضافة أي عناصر، نخفي قسم التاريخ
          if (historyItems.children.length === 0) {
            historySection.style.display = 'none';
          }
        } else {
          historySection.style.display = 'none';
        }
      }
      
      // إنشاء زر التاريخ
      function createHistoryButton(url, title) {
        const button = document.createElement('a');
        button.className = 'history-button';
        button.href = url;
        button.setAttribute('download', `${title}.pdf`);
        button.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-left: 0.5rem;">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>
          ${title}
        `;
        return button;
      }
      
      // عرض النتائج السابقة للمفتاح المستخدم
      function showPreviousResults(key) {
        // التحقق من أن العملية ليست قيد التنفيذ بالفعل
        if (isProcessing) {
          return;
        }
        
        // تعيين حالة المعالجة
        isProcessing = true;
        
        // عرض شريط التقدم
        const progressContainer = document.getElementById('progressBarContainer');
        const progressFill = document.getElementById('validateProgressFill');
        const progressText = document.getElementById('validateProgressText');
        const progressWisdom = document.getElementById('validateProgressWisdom');
        
        progressContainer.style.display = 'block';
        
        // تحديث شريط التقدم تدريجياً
        const progressUpdater = updateProgressBar(progressFill, progressText, progressWisdom, [
          { progress: 20, text: 'جاري استرجاع البيانات السابقة...' },
          { progress: 40, text: 'جاري البحث عن الملفات...' },
          { progress: 60, text: 'جاري تحضير الملفات...' },
          { progress: 80, text: 'جاري تجهيز الصفحة...' }
        ]);
        
        google.script.run
          .withSuccessHandler(function(result) {
            // إيقاف حالة المعالجة
            isProcessing = false;
            
            if (result) {
              // إكمال شريط التقدم
              progressUpdater.completeProgress('تم استرجاع الملفات بنجاح');
              
              // إخفاء شريط التقدم بعد فترة قصيرة
              setTimeout(() => {
                // إزالة شريط التقدم
                progressContainer.style.display = 'none';
                
                // الانتقال إلى صفحة النتائج مباشرة
                showSection('result');
                
                // عرض معاينات الملفات
                displayPdfTabs(result);
                
                // عرض رسالة نجاح
                showToast('تم جلب الملفات السابقة بنجاح', 'success');
              }, 1000);
            } else {
              // إيقاف تحديث شريط التقدم
              progressUpdater.stopProgress();
              
              // إخفاء شريط التقدم
              progressContainer.style.display = 'none';
              
              showToast('لم يتم العثور على بيانات سابقة', 'error');
            }
          })
          .withFailureHandler(function(error) {
            // إيقاف حالة المعالجة
            isProcessing = false;
            
            // إيقاف تحديث شريط التقدم
            progressUpdater.stopProgress();
            
            // إخفاء شريط التقدم
            progressContainer.style.display = 'none';
            
            showToast('تعذر استرجاع الملفات السابقة', 'error');
          })
          .getPreviousResults(currentKey);
      }
      
      // دالة إرسال النموذج
      function submitForm() {
        // التحقق من أن النموذج لم يتم إرساله بالفعل أو أن العملية قيد التنفيذ
        if (wasSubmitted || isProcessing) {
          return;
        }
        
        const nameInput = document.getElementById('fullName');
        const fileInput = document.getElementById('photoUpload');
        const teamNumberInput = document.getElementById('teamNumber');
        const serialNumberInput = document.getElementById('serialNumber');
        const submitBtn = document.getElementById('submitFormBtn');
        const submitError = document.getElementById('submitError');
        const progressContainer = document.getElementById('formProgressContainer');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const progressWisdom = document.getElementById('progressWisdom');
        
        // الحصول على البيانات
        const name = nameInput.value.trim();
        submitError.style.display = 'none';
        
        // التحقق من البيانات المطلوبة
        if (!name) {
          submitError.textContent = 'الرجاء إدخال الاسم الثلاثي';
          submitError.style.display = 'block';
          nameInput.focus();
          return;
        }
        
        // تعيين حالة المعالجة
        isProcessing = true;
        wasSubmitted = true;
        
        // تعطيل النموذج وزر الإرسال
        document.querySelectorAll('.form-input').forEach(input => {
          input.disabled = true;
        });
        
        document.querySelectorAll('input[type="radio"]').forEach(radio => {
          radio.disabled = true;
        });
        
        submitBtn.disabled = true;
        
        // إعداد البيانات المشتركة
        const formData = {
          name: name,
          key: currentKey,
          rank: currentRank
        };
        
        // عرض شريط التقدم
        progressContainer.style.display = 'block';
        
        // تحديث شريط التقدم تدريجياً
        const progressUpdater = updateProgressBar(progressFill, progressText, progressWisdom, [
          { progress: 15, text: 'جاري إعداد البيانات...' },
          { progress: 30, text: 'جاري تحميل البيانات...' }
        ]);
        
        // التحقق من البيانات المطلوبة بناءً على الرتبة
        if (currentRank === 'قائد' || currentRank === 'كشاف') {
          // إضافة رقم الفرقة والرقم التسلسلي
          formData.teamNumber = teamNumberInput.value.trim();
          formData.serialNumber = serialNumberInput.value.trim();
          
          // التحقق من الصورة
          const file = fileInput.files[0];
          
          if (!file) {
            isProcessing = false;
            wasSubmitted = false;
            submitError.textContent = 'الرجاء اختيار صورة شخصية';
            submitError.style.display = 'block';
            
            // إعادة تمكين النموذج
            document.querySelectorAll('.form-input').forEach(input => {
              input.disabled = false;
            });
            
            document.querySelectorAll('input[type="radio"]').forEach(radio => {
              radio.disabled = false;
            });
            
            submitBtn.disabled = false;
            
            // إيقاف تحديث شريط التقدم
            progressUpdater.stopProgress();
            
            // إخفاء شريط التقدم
            progressContainer.style.display = 'none';
            
            return;
          }
          
          // التحقق من نوع ملف الصورة
          const allowedTypes = ['image/jpeg', 'image/png', 'image/jpg', 'image/gif'];
          if (!allowedTypes.includes(file.type)) {
            isProcessing = false;
            wasSubmitted = false;
            submitError.textContent = 'نوع الملف غير مدعوم. يرجى تحميل JPG أو PNG أو GIF.';
            submitError.style.display = 'block';
            
            // إعادة تمكين النموذج
            document.querySelectorAll('.form-input').forEach(input => {
              input.disabled = false;
            });
            
            document.querySelectorAll('input[type="radio"]').forEach(radio => {
              radio.disabled = false;
            });
            
            submitBtn.disabled = false;
            
            // إيقاف تحديث شريط التقدم
            progressUpdater.stopProgress();
            
            // إخفاء شريط التقدم
            progressContainer.style.display = 'none';
            
            return;
          }
          
          // التحقق من حجم الملف (الحد الأقصى 20 ميجابايت)
          const maxSize = 20 * 1024 * 1024;
          if (file.size > maxSize) {
            isProcessing = false;
            wasSubmitted = false;
            submitError.textContent = 'حجم الصورة كبير جدًا. الحد الأقصى هو 20 ميجابايت.';
            submitError.style.display = 'block';
            
            // إعادة تمكين النموذج
            document.querySelectorAll('.form-input').forEach(input => {
              input.disabled = false;
            });
            
            document.querySelectorAll('input[type="radio"]').forEach(radio => {
              radio.disabled = false;
            });
            
            submitBtn.disabled = false;
            
            // إيقاف تحديث شريط التقدم
            progressUpdater.stopProgress();
            
            // إخفاء شريط التقدم
            progressContainer.style.display = 'none';
            
            return;
          }
          
          // إضافة معلومات الصورة
          const reader = new FileReader();
          reader.onload = function(e) {
            // تحديث شريط التقدم
            progressUpdater.stopProgress();
            
            // إنشاء تحديث جديد لشريط التقدم
            const uploadProgressUpdater = updateProgressBar(progressFill, progressText, progressWisdom, [
              { progress: 45, text: 'جاري تحميل الصورة...' },
              { progress: 60, text: 'جاري معالجة الصورة...' },
              { progress: 75, text: 'جاري إنشاء المستندات...' }
            ]);
            
            // تقسيم البيانات للحصول على الـ base64 فقط
            const base64String = e.target.result;
            formData.base64Image = base64String;
            formData.mimeType = file.type;
            
            // إضافة معلومات إضافية للقائد
            if (currentRank === 'قائد') {
              const leaderTypeRadios = document.getElementsByName('leaderType');
              for (const radio of leaderTypeRadios) {
                if (radio.checked) {
                  formData.gender = radio.value;
                  break;
                }
              }
            }
            
            // إرسال البيانات
            processFormData(formData, uploadProgressUpdater);
          };
          reader.readAsDataURL(file);
        } else {
          // للجان: لا نحتاج إلى صورة أو حقول إضافية
          progressUpdater.stopProgress();
          
          // إنشاء تحديث جديد لشريط التقدم
          const uploadProgressUpdater = updateProgressBar(progressFill, progressText, progressWisdom, [
            { progress: 45, text: 'جاري تحميل البيانات...' },
            { progress: 60, text: 'جاري معالجة البيانات...' },
            { progress: 75, text: 'جاري إنشاء المستندات...' }
          ]);
          
          // إرسال البيانات مباشرة
          processFormData(formData, uploadProgressUpdater);
        }
      }
      
      // معالجة بيانات النموذج
      function processFormData(formData, progressUpdater) {
        google.script.run
          .withSuccessHandler(function(result) {
            // إكمال شريط التقدم
            progressUpdater.completeProgress('اكتملت العملية بنجاح!');
            
            // إخفاء شريط التقدم بعد فترة قصيرة
            setTimeout(() => {
              // إخفاء شريط التقدم
              document.getElementById('formProgressContainer').style.display = 'none';
              
              // عرض رسالة النجاح
              showToast('تم إنشاء المستندات بنجاح!', 'success');
              
              // عرض معاينات الملفات باستخدام تبويبات
              displayPdfTabs(result);
              
              // الانتقال إلى صفحة النتائج
              showSection('result');
              
              // إعادة تعيين حالة المعالجة
              isProcessing = false;
            }, 1000);
          })
          .withFailureHandler(function(error) {
            // إيقاف تحديث شريط التقدم
            progressUpdater.stopProgress();
            
            // إخفاء شريط التقدم
            document.getElementById('formProgressContainer').style.display = 'none';
            
            // إعادة تمكين النموذج
            document.querySelectorAll('.form-input').forEach(input => {
              input.disabled = false;
            });
            
            document.querySelectorAll('input[type="radio"]').forEach(radio => {
              radio.disabled = false;
            });
            
            document.getElementById('submitFormBtn').disabled = false;
            
            // عرض رسالة الخطأ
            const submitError = document.getElementById('submitError');
            submitError.textContent = error || 'حدث خطأ أثناء معالجة البيانات. الرجاء المحاولة مرة أخرى.';
            submitError.style.display = 'block';
            
            showToast(error || 'حدث خطأ أثناء معالجة البيانات.', 'error');
            
            // إعادة تعيين الحالات
            isProcessing = false;
            wasSubmitted = false;
          })
          .processFormWithImage(formData);
      }
      
      // عرض معاينات ملفات PDF باستخدام تبويبات
      function displayPdfTabs(result) {
        const tabsContainer = document.getElementById('pdfTabs');
        const tabContentsContainer = document.getElementById('pdfTabContents');
        
        // مسح المحتوى السابق
        tabsContainer.innerHTML = '';
        tabContentsContainer.innerHTML = '';
        
        // تحديد الملفات المتاحة حسب الرتبة والتحقق من وجودها
        let pdfs = [];
        let missingPdfs = [];
        
        // إضافة PDF حسب الرتبة - فقط إذا كانت غير فارغة
        if (currentRank === 'كشاف' || currentRank === 'قائد') {
          if (result.pdf1) {
            pdfs.push({ id: 'pdf1', title: 'الشهادة', url: result.pdf1 });
          } else {
            // تسجيل PDF المفقود
            missingPdfs.push('الشهادة');
          }
          
          if (result.pdf2) {
            pdfs.push({ id: 'pdf2', title: 'البطاقة', url: result.pdf2 });
          } else {
            missingPdfs.push('البطاقة');
          }
        }
        
        if (currentRank === 'لجان' || currentRank === 'قائد') {
          if (result.pdf3) {
            pdfs.push({ id: 'pdf3', title: 'الكتيب', url: result.pdf3 });
          } else {
            missingPdfs.push('الكتيب');
          }
        }
        
        // التحقق من وجود ملفات متاحة
        if (pdfs.length === 0) {
          // إذا لم يكن هناك ملفات متاحة، عرض رسالة
          tabContentsContainer.innerHTML = `
            <div class="tab-content active">
              <div class="pdf-preview">
                <h3 class="pdf-preview-title" style="color: var(--error);">عذراً، الشهادات غير متوفرة حاليًا</h3>
                <p style="text-align: center; margin: 2rem 0;">الشهادات ليست جاهزة بعد. يرجى المحاولة لاحقًا.</p>
              </div>
            </div>
          `;
          return;
        }
        
        // إنشاء التبويبات والمحتوى لكل ملف متاح
        pdfs.forEach((pdf, index) => {
          // إنشاء زر التبويب
          const tabButton = document.createElement('button');
          tabButton.id = `tab-${pdf.id}`;
          tabButton.className = `tab-button ${index === 0 ? 'active' : ''}`;
          tabButton.textContent = pdf.title;
          tabButton.onclick = () => switchTab(pdf.id);
          tabsContainer.appendChild(tabButton);
          
          // إنشاء محتوى التبويب
          const tabContent = document.createElement('div');
          tabContent.id = `content-${pdf.id}`;
          tabContent.className = `tab-content ${index === 0 ? 'active' : ''}`;
          
          // إضافة معاينة PDF
          tabContent.innerHTML = `
            <div class="pdf-preview">
              <h3 class="pdf-preview-title">${pdf.title}</h3>
              <div class="pdf-container">
                <iframe class="pdf-frame" src="${pdf.url}" title="${pdf.title}" sandbox="allow-scripts allow-same-origin"></iframe>
              </div>
              <a href="${pdf.url}" download="${pdf.title}.pdf" class="download-button">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-left: 0.5rem;">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="7 10 12 15 17 10"></polyline>
                  <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                تحميل ${pdf.title}
              </a>
            </div>
          `;
          
          tabContentsContainer.appendChild(tabContent);
        });
        
        // عرض رسالة للملفات المفقودة إذا وجدت
        if (missingPdfs.length > 0 && pdfs.length > 0) {
          const noticeDiv = document.createElement('div');
          noticeDiv.className = 'pdf-preview-title';
          noticeDiv.style.marginTop = '1rem';
          noticeDiv.style.color = 'var(--accent)';
          noticeDiv.style.fontSize = '0.9rem';
          noticeDiv.textContent = `ملاحظة: ${missingPdfs.join(' و ')} ليست جاهزة بعد.`;
          tabContentsContainer.appendChild(noticeDiv);
        }
      }
      
      // تبديل التبويبات
      function switchTab(pdfId) {
        // تحديث أزرار التبويبات
        const tabButtons = document.querySelectorAll('.tab-button');
        tabButtons.forEach(button => {
          button.classList.remove('active');
          if (button.id === `tab-${pdfId}`) {
            button.classList.add('active');
          }
        });
        
        // تحديث محتوى التبويبات
        const tabContents = document.querySelectorAll('.tab-content');
        tabContents.forEach(content => {
          content.classList.remove('active');
          if (content.id === `content-${pdfId}`) {
            content.classList.add('active');
          }
        });
      }
      
      // دالة عرض رسالة توست
      function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toastMessage');
        const toastIcon = document.querySelector('.toast-icon');
        
        // تعيين النوع والرسالة
        toast.className = `toast ${type}`;
        toastMessage.textContent = message;
        
        // تعيين الأيقونة حسب النوع
        if (type === 'success') {
          toastIcon.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" viewBox="0 0 24 24" style="width: 25px;height: 20px;" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
              <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
          `;
        } else {
          toastIcon.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" viewBox="0 0 24 24" style="width: 25px;height: 20px;" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="8" x2="12" y2="12"></line>
              <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
          `;
        }
        
        // عرض التوست مع تأثير انزلاق
        requestAnimationFrame(() => {
          toast.classList.add("show");
          
          // إخفاء التوست بعد 3 ثواني
          setTimeout(() => {
            toast.classList.remove("show");
          }, 3000);
        });
      }
      
      // منع تغيير الأقسام عبر تعديل العناصر مباشرة
      // مراقبة تغييرات العناصر المخفية
      const mutationObserver = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.type === 'attributes' &&
              (mutation.attributeName === 'class' || 
               mutation.attributeName === 'style' || 
               mutation.attributeName === 'data-active')) {
            
            const section = mutation.target;
            
            // إذا كان القسم مخفيًا ولكن تم تغيير حالته
            if (section.classList.contains('section') && 
                section.dataset.active === 'false' && 
                !section.classList.contains('hidden')) {
              
              // إعادة إخفاء القسم
              section.classList.add('hidden');
              section.classList.remove('visible');
              
              // عرض رسالة تحذير
              showToast('عملية غير مصرح بها', 'error');
              console.warn('محاولة وصول غير مصرح بها');
            }
          }
        });
      });
      
      // تطبيق المراقب على جميع الأقسام
      document.querySelectorAll('.section').forEach(section => {
        mutationObserver.observe(section, {
          attributes: true,
          attributeFilter: ['class', 'style', 'data-active']
        });
      });
      
      // إضافة إجراء واقي عند تحميل الصفحة
      window.addEventListener('load', function() {
        // التحقق من حالة الأقسام وإعادة ضبطها إذا لزم الأمر
        Object.keys(sections).forEach(key => {
          if (key === 'key') {
            sections[key].classList.remove('hidden');
            sections[key].classList.add('visible');
            sections[key].dataset.active = 'true';
          } else {
            sections[key].classList.remove('visible');
            sections[key].classList.add('hidden');
            sections[key].dataset.active = 'false';
          }
        });
      });
      
      // إضافة إجراء واقي لأخطاء الشبكة
      window.addEventListener('offline', function() {
        showToast('انقطع الاتصال بالإنترنت', 'error');
      });
      
      window.addEventListener('online', function() {
        showToast('تم استعادة الاتصال بالإنترنت', 'success');
      });
    });
  </script>
</body>
</html>
