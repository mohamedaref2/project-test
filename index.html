<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>نموذج بيانات</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
    body {
      font-family: 'Cairo', sans-serif;
      direction: rtl;
      text-align: right;
      background-color: #f8f9fa;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    .card {
      border-radius: 15px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      overflow: hidden;
    }
    .card-header {
      background-color: #6c757d;
      color: white;
      font-weight: bold;
      padding: 15px;
    }
    .card-body {
      padding: 20px;
    }
    .form-label {
      font-weight: bold;
    }
    .form-control {
      margin-bottom: 15px;
    }
    .btn-primary {
      background-color: #6c757d;
      border-color: #6c757d;
    }
    .btn-primary:hover {
      background-color: #5a6268;
      border-color: #545b62;
    }
    .preview-container {
      margin-top: 30px;
    }
    .preview-card {
      margin-bottom: 20px;
    }
    .preview-header {
      background-color: #e9ecef;
      padding: 10px;
      font-weight: bold;
      border-radius: 5px 5px 0 0;
    }
    .preview-body {
      border: 1px solid #dee2e6;
      border-top: none;
      padding: 15px;
      border-radius: 0 0 5px 5px;
    }
    #progressBar {
      display: none;
      margin-top: 20px;
    }
    #pdfPreview {
      display: none;
      margin-top: 30px;
    }
    .download-btn {
      margin-top: 10px;
    }
    /* Custom scrollbar */
    .custom-scrollbar {
      scrollbar-width: thin;
      scrollbar-color: #9b87f5 #f3f3f3;
    }

    .custom-scrollbar::-webkit-scrollbar {
      width: 8px;
      background: #f3f3f3;
      border-radius: 8px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: #9b87f5;
      border-radius: 8px;
      min-height: 32px;
    }

    .image-upload-btn {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: background 0.2s, border-color 0.2s;
      border: 2px dashed #9b87f5;
      border-radius: 1rem;
      background: #f1f0fb;
      cursor: pointer;
      overflow: hidden;
      min-height: 140px;
    }
    .image-upload-btn img {
      max-width: 80px;
      max-height: 80px;
      margin-bottom: 0.5rem;
      border-radius: 0.7rem;
      box-shadow: 0 2px 12px 0 #9b87f520;
      transition: box-shadow 0.2s;
    }
    .image-upload-btn:hover {
      background: #E5DEFF;
      border-color: #7E69AB;
    }
    .image-upload-infos {
      text-align: center;
      color: #7E69AB;
      font-size: 1rem;
      margin-top: 0.25rem;
      font-weight: 500;
    }
    .image-upload-btn input[type="file"] {
      position: absolute;
      inset: 0;
      opacity: 0;
      z-index: 2;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    @media (max-width: 600px) {
      .modern-card {
        padding: 1rem !important;
      }
      .form-2col {
        flex-direction: column !important;
        gap: 0.5rem !important;
      }
    }

    .download-btn-modern {
      color: #fff;
      background: #8B5CF6;
      border-radius: 999px;
      border: none;
      padding: 0.4em 0.9em 0.4em 0.6em;
      font-size: 0.95em;
      margin-left: 1em;
      display: inline-flex;
      align-items: center;
      gap: 0.35em;
      transition: background 0.2s, box-shadow 0.2s;
      box-shadow: 0 1px 8px #1A1F2C30;
      cursor: pointer;
    }

    .download-btn-modern:hover {
      background: #7E69AB;
    }

    .file-preview-header {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 0.3em;
      padding-bottom: 0.25em;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="text-center mb-4">نموذج بيانات</h1>
    
    <div class="modern-card" style="overflow: hidden; max-width: 470px; margin: auto; border-radius: 1.5rem; background: #fff; padding: 2rem 2.2rem; box-shadow: 0 4px 40px #9b87f533;">
      <form id="dataForm" onsubmit="submitForm(event)">
        <div class="mb-3">
          <label for="name" class="form-label">الاسم</label>
          <input type="text" class="form-control" id="name" name="name" required>
        </div>
        
        <div class="mb-3">
          <label for="rank" class="form-label">الرتبة</label>
          <select class="form-select" id="rank" name="rank" required>
            <option value="">اختر الرتبة</option>
            <option value="ملازم">ملازم</option>
            <option value="ملازم أول">ملازم أول</option>
            <option value="نقيب">نقيب</option>
            <option value="رائد">رائد</option>
            <option value="مقدم">مقدم</option>
            <option value="عقيد">عقيد</option>
            <option value="عميد">عميد</option>
            <option value="لواء">لواء</option>
          </select>
        </div>
        
        <!-- Image Upload (Modern logic) -->
        <label class="image-upload-btn" id="customImageUpload">
          <input
            type="file"
            accept="image/png, image/jpeg"
            id="profilePic"
            name="profilePic"
            onchange="onProfilePicChange(event)"
          />
          <div id="imageUploadContent">
            <!-- JS will toggle this area for icon/text and preview -->
            <svg xmlns="http://www.w3.org/2000/svg" style="width:36px;height:36px;color:#9b87f5; display:block; margin:0 auto 0.6rem;" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
            <div class="image-upload-infos" id="imgUploadText">
              اختر الصوره<br />
              <span style="font-size: 0.93em; color: #888;">
                الحد الاقصي للملف 20 ميجا<br>
                الصيغ المسموحه png و jpg
              </span>
            </div>
          </div>
        </label>
        <script>
          function onProfilePicChange(e) {
            const file = e.target.files[0];
            if (!file) { return; }
            // Validate type/size
            const allowed = ['image/jpeg', 'image/png'];
            const max = 20 * 1024 * 1024;
            if (!allowed.includes(file.type) || file.size > max) {
              alert("ملف غير مدعوم. يجب أن يكون أصغر من 20MB وبصيغة PNG/JPG.");
              e.target.value = "";
              return;
            }

            // Show preview in place (remove text/icon), make image clickable for re-select
            const url = URL.createObjectURL(file);
            document.getElementById("imageUploadContent").innerHTML = `
              <img src="${url}" alt="الصورة المُختارة" style="display:block;cursor:pointer;border-radius:0.7em;max-width:90px;max-height:90px;margin:auto;" id="imgPreviewChosen" />
              <div class="image-upload-infos" style="font-size:0.93em;color:#888;">
                للضغط مجددًا لتغيير الصورة<br/>
                الحد الاقصي للملف 20 ميجا — الصيغ المسموحه png و jpg
              </div>
            `;
            document.getElementById("customImageUpload").onclick = function() {
              document.getElementById("profilePic").click();
            };
            // Accessibility: focus file input
            document.getElementById("profilePic").focus();
          }
          // Restore to default when clearing form
          function resetImagePicker() {
            document.getElementById("imageUploadContent").innerHTML = `
              <svg xmlns="http://www.w3.org/2000/svg" style="width:36px;height:36px;color:#9b87f5; display:block; margin:0 auto 0.6rem;" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
              <div class="image-upload-infos" id="imgUploadText">
                اختر الصوره<br />
                <span style="font-size: 0.93em; color: #888;">
                  الحد الاقصي للملف 20 ميجا<br>
                  الصيغ المسموحه png و jpg
                </span>
              </div>
            `;
            document.getElementById("customImageUpload").onclick = null;
          }
        </script>

        <!-- Example for "رقم الفرقة" و"الرقم التسلسلي" in same line, assuming both are input text fields -->
        <div class="form-2col" style="display:flex;gap:1.5em;align-items:flex-end;">
          <div style="flex:1;">
            <label for="groupNum" style="font-weight: bold; color:#1A1F2C;">رقم الفرقة</label>
            <input id="groupNum" name="groupNum" type="text" class="form-input" style="width:100%;" />
          </div>
          <div style="flex:1;">
            <label for="serialNum" style="font-weight: bold; color:#1A1F2C;">الرقم التسلسلي</label>
            <input id="serialNum" name="serialNum" type="text" class="form-input" style="width:100%;" />
          </div>
        </div>

        <!-- Main card scrollable area -->
        <div class="custom-scrollbar" style="max-height: 370px; overflow-y: auto; margin-top:1.5em;">
          <div class="mb-3">
            <label for="unit" class="form-label">الوحدة</label>
            <input type="text" class="form-control" id="unit" name="unit" required>
          </div>
          
          <div class="mb-3">
            <label for="address" class="form-label">العنوان</label>
            <textarea class="form-control" id="address" name="address" rows="3" required></textarea>
          </div>
          
          <div class="mb-3">
            <label for="phone" class="form-label">رقم الهاتف</label>
            <input type="tel" class="form-control" id="phone" name="phone" required>
          </div>
          
          <div class="mb-3">
            <label for="email" class="form-label">البريد الإلكتروني</label>
            <input type="email" class="form-control" id="email" name="email">
          </div>
          
          <div class="mb-3">
            <label for="notes" class="form-label">ملاحظات</label>
            <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
          </div>
          
          <div id="progressArea"></div>
          
          <div class="text-center">
            <button type="submit" class="btn btn-primary">إرسال البيانات</button>
            <button type="button" class="btn btn-secondary" onclick="resetForm()">إعادة تعيين</button>
          </div>
        </div>
      </form>
    </div>

    <div id="pdfPreviewSection" style="display: none;">
      <div class="modern-card" style="max-width: 570px; margin: auto; border-radius: 1.2rem; background: #fff; padding: 2.2rem; box-shadow: 0 4px 48px #9b87f544;">
        <h2 style="font-size:1.4em; font-weight:600; color:#8B5CF6; margin-bottom:0.7em;">ملفاتك الجاهزة</h2>
        <div id="pdfFilesList"></div>
      </div>
    </div>
  </div>

  <script>
    // To show preview section after file generation and navigate to it
    function showPreviewSection(files) {
      document.querySelector('.modern-card').style.display = 'none';
      document.getElementById('pdfPreviewSection').style.display = 'block';
      listGeneratedFiles(files);
    }

    // Render PDF files preview and download buttons
    function listGeneratedFiles(files) {
      const list = document.getElementById("pdfFilesList");
      list.innerHTML = "";
      files.forEach((file, idx) => {
        const fileId = "filePreview_" + idx;
        // Customized download button location & style
        list.innerHTML += `
          <div style="margin-bottom:2.1em;">
            <div class="file-preview-header">
              <span style="font-weight:600;font-size:1.12em;">
                <svg xmlns="http://www.w3.org/2000/svg" style="width:20px;height:20px;color:#9b87f5;margin-left:0.2em;vertical-align:middle;" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21H5a2 2 0 01-2-2V7a2 2 0 012-2h5V5a2 2 0 012-2h3.6A2 2 0 0121 5v14a2 2 0 01-2 2z"></path></svg>
                ${file.name}
              </span>
              <button class="download-btn-modern" onclick="downloadFile('${file.id}')">
                تحميل
                <svg xmlns="http://www.w3.org/2000/svg" style="width:18px;height:18px;" fill="none" viewBox="0 0 24 24" stroke="#fff"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2M7 10l5 5 5-5M12 15V3"></path></svg>
              </button>
            </div>
            <iframe src="${file.url}" style="width:100%;min-height:290px; border: 1px solid #eee; border-radius:0.7em;box-shadow:0 2px 16px #e5deff44"></iframe>
          </div>
        `;
      });
    }

    function downloadFile(fileId) {
      // Call Apps Script endpoint or link for download, assuming /download?id=
      window.open('/download?id=' + encodeURIComponent(fileId), '_blank');
    }

    // Handle form submission: block editing after submit + progress indicator
    function onFormSubmit(event) {
      event.preventDefault();
      // Block inputs
      Array.from(document.querySelectorAll('.modern-card input, .modern-card textarea, .modern-card button')).forEach(el => {
        el.setAttribute('readonly', 'readonly');
        el.disabled = true;
      });

      // Visual modern progress: text + bar + rotating wise texts
      document.getElementById("progressArea").innerHTML = `
        <div style="text-align:center;">
          <div id="changingWiseText" style="animation:fadeIn 0.8s;font-size:1.05em;color:#8B5CF6;font-weight:600;margin:0 0 0.75em;">الصبر مفتاح الفرج</div>
          <div style="background:#E5DEFF;border-radius:999px;overflow:hidden;padding:5px 16px;">
            <div id="progressBarInner" style="background:#8B5CF6;height:10px;border-radius:999px;width:0%;transition:width 0.6s;"></div>
          </div>
        </div>
      `;
      const wiseTexts = [
        "الصبر مفتاح الفرج", "النجاح حليف المثابرين", "كل تأخيرة وفيها خيرة", "من جد وجد", "العجلة من الشيطان", "تفاءلوا بالخير تجدوه"
      ];
      let wiseIdx = 0;
      const wiseIntv = setInterval(() => {
        wiseIdx = (wiseIdx + 1) % wiseTexts.length;
        document.getElementById("changingWiseText").textContent = wiseTexts[wiseIdx];
      }, 2000);

      // Fake progress for UX, replaced by real progress if available
      let progress = 0;
      const interval = setInterval(() => {
        progress += 15;
        document.getElementById("progressBarInner").style.width = Math.min(progress, 100) + "%";
        if (progress >= 100) clearInterval(interval);
      }, 850);

      // Gather data & AJAX submit to Apps Script
      const formData = new FormData(document.getElementById('dataForm'));
      
      google.script.run
        .withSuccessHandler(function(result) {
          clearInterval(interval);
          clearInterval(wiseIntv);
          document.getElementById("progressArea").innerHTML = "";
          if (result.files) {
            showPreviewSection(result.files);
          } else {
            alert("تم الحفظ ولكن لم يتم الحصول على الملفات. يرجى تحديث الصفحة.");
          }
        })
        .withFailureHandler(function(error) {
          clearInterval(interval);
          clearInterval(wiseIntv);
          document.getElementById("progressArea").innerHTML = "";
          alert("حصل خطأ أثناء رفع البيانات. حاول مجددًا.");
          // Revert readonly/disabled
          Array.from(document.querySelectorAll('.modern-card input, .modern-card textarea, .modern-card button')).forEach(el => {
            el.removeAttribute('readonly');
            el.disabled = false;
          });
        })
        .processForm(formData);

      return false;
    }

    function submitForm(event) {
      event.preventDefault();
      onFormSubmit(event);
    }

    function resetForm() {
      document.getElementById('dataForm').reset();
      resetImagePicker();
    }
  </script>
</body>
</html>
