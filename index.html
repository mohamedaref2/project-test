
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>نظام التسجيل الإلكتروني</title>
  <!-- Particles.js for background effects -->
  <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            border: 'rgb(229, 231, 235)',
            input: 'rgb(229, 231, 235)',
            ring: 'rgb(17, 24, 39)',
            background: 'rgb(255, 255, 255)',
            foreground: 'rgb(17, 24, 39)',
            primary: {
              DEFAULT: 'rgb(79, 70, 229)',
              foreground: 'rgb(255, 255, 255)'
            },
            secondary: {
              DEFAULT: 'rgb(243, 244, 246)',
              foreground: 'rgb(17, 24, 39)'
            },
            destructive: {
              DEFAULT: 'rgb(239, 68, 68)',
              foreground: 'rgb(255, 255, 255)'
            },
            muted: {
              DEFAULT: 'rgb(243, 244, 246)',
              foreground: 'rgb(107, 114, 128)'
            },
            accent: {
              DEFAULT: 'rgb(243, 244, 246)',
              foreground: 'rgb(17, 24, 39)'
            },
            success: {
              DEFAULT: 'rgb(34, 197, 94)',
              foreground: 'rgb(255, 255, 255)'
            }
          },
          borderRadius: {
            lg: '0.5rem',
            md: '0.375rem',
            sm: '0.25rem'
          },
          keyframes: {
            'fade-in': {
              '0%': { opacity: '0', transform: 'translateY(10px)' },
              '100%': { opacity: '1', transform: 'translateY(0)' }
            },
            'fade-out': {
              '0%': { opacity: '1', transform: 'translateY(0)' },
              '100%': { opacity: '0', transform: 'translateY(10px)' }
            }
          },
          animation: {
            'fade-in': 'fade-in 0.3s ease-out',
            'fade-out': 'fade-out 0.3s ease-out'
          }
        }
      }
    };
  </script>
  <style>
    /* Base styles */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: rgb(243, 244, 246);
      min-height: 100vh;
    }

    .dark {
      background-color: rgb(17, 24, 39);
      color: rgb(255, 255, 255);
    }

    /* Custom scrollbar styles */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: rgb(156, 163, 175);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgb(107, 114, 128);
    }

    /* Hide scrollbar for Chrome, Safari and Opera */
    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }

    /* Hide scrollbar for IE, Edge and Firefox */
    .no-scrollbar {
      -ms-overflow-style: none;  /* IE and Edge */
      scrollbar-width: none;  /* Firefox */
    }

    /* Particle effects */
    #particles canvas {
      position: fixed !important;
      left: 0 !important;
      top: 0 !important;
      width: 100% !important;
      height: 100% !important;
      z-index: 0 !important;
    }

    /* Progress bar */
    .progress {
      position: relative;
      height: 0.5rem;
      width: 100%;
      overflow: hidden;
      border-radius: 0.25rem;
      background-color: rgb(229, 231, 235);
    }

    .dark .progress {
      background-color: rgb(55, 65, 81);
    }

    .progress-bar {
      height: 100%;
      width: 0;
      background-color: rgb(79, 70, 229);
      transition: width 0.3s ease;
    }

    /* Toast */
    .toast-container {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 9999;
    }

    .toast {
      display: flex;
      align-items: center;
      padding: 1rem;
      background-color: white;
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      margin-bottom: 0.5rem;
      min-width: 300px;
      max-width: 500px;
      opacity: 0;
      transform: translateY(-20px);
      animation: toast-in 0.3s forwards;
    }

    .dark .toast {
      background-color: rgb(55, 65, 81);
      color: white;
    }

    .toast-success {
      border-left: 4px solid rgb(34, 197, 94);
    }

    .toast-error {
      border-left: 4px solid rgb(239, 68, 68);
    }

    .toast-title {
      font-weight: bold;
      margin-bottom: 0.25rem;
    }

    .toast-message {
      font-size: 0.875rem;
    }

    @keyframes toast-in {
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Tabs */
    .tabs {
      display: flex;
      flex-direction: column;
      width: 100%;
    }

    .tabs-list {
      display: flex;
      background-color: rgb(243, 244, 246);
      border-radius: 0.5rem;
      padding: 0.25rem;
      margin-bottom: 1rem;
    }

    .dark .tabs-list {
      background-color: rgb(55, 65, 81);
    }

    .tab-trigger {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
      font-weight: 500;
      color: rgb(107, 114, 128);
      border-radius: 0.25rem;
      cursor: pointer;
    }

    .dark .tab-trigger {
      color: rgb(209, 213, 219);
    }

    .tab-trigger[data-state="active"] {
      background-color: white;
      color: rgb(17, 24, 39);
      box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    }

    .dark .tab-trigger[data-state="active"] {
      background-color: rgb(31, 41, 55);
      color: white;
    }

    .tab-content {
      display: none;
    }

    .tab-content[data-state="active"] {
      display: block;
    }

    /* Collapsible */
    .collapsible {
      width: 100%;
    }

    .collapsible-trigger {
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      background: none;
      border: none;
      text-align: right;
      cursor: pointer;
    }

    .collapsible-content {
      overflow: hidden;
      height: 0;
      transition: height 0.3s ease;
    }

    .collapsible-content[data-state="open"] {
      height: auto;
    }

    .chevron-down {
      transition: transform 0.3s ease;
    }

    .rotate-180 {
      transform: rotate(180deg);
    }

    /* Animations */
    .animate-fade-in {
      animation: fade-in 0.3s ease-out;
    }

    .transition-all {
      transition-property: all;
      transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
      transition-duration: 150ms;
    }

    .transition-opacity {
      transition-property: opacity;
      transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
      transition-duration: 150ms;
    }

    .transition-transform {
      transition-property: transform;
      transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
      transition-duration: 150ms;
    }
  </style>
</head>
<body>
  <!-- Particles background -->
  <div id="particles" class="absolute inset-0 z-0"></div>

  <!-- Main container -->
  <div id="app" class="min-h-screen flex items-center justify-center p-4"></div>

  <!-- Toast container -->
  <div id="toast-container" class="toast-container"></div>

  <script>
    // ================ Types ================
    /**
     * @typedef PDFResult
     * @property {string|null} pdf1
     * @property {string|null} pdf2
     * @property {string|null} pdf3
     */

    /**
     * @typedef UserRecord
     * @property {string} name
     * @property {string} key
     * @property {string|null} pdf1
     * @property {string|null} pdf2
     * @property {string|null} pdf3
     * @property {string} [teamNumber]
     * @property {string} [serialNumber]
     * @property {string} [gender]
     * @property {string} date
     */

    /**
     * @typedef {"key"|"form"|"result"} StepType
     */

    // ================ Global State ================
    const state = {
      isDarkMode: false,
      currentStep: /** @type {StepType} */ ("key"),
      accessKey: "",
      fullName: "",
      teamNumber: "",
      serialNumber: "",
      gender: "",
      isLoading: false,
      errorMsg: "",
      photoFile: /** @type {File|null} */ (null),
      photoPreview: "",
      userRank: "",
      isKeyUsed: false,
      results: /** @type {PDFResult|null} */ (null),
      previousFiles: /** @type {UserRecord[]} */ ([]),
      progress: 0,
      progressText: "",
      isCollapsibleOpen: false,
      activeTab: "pdf1",
      wisdomQuote: "",
      progressInterval: null,
      quoteInterval: null
    };

    const wisdomQuotes = [
      "الصبر مفتاح الفرج",
      "من جدّ وجد",
      "العلم نور",
      "خير الأمور أوسطها",
      "من سار على الدرب وصل",
      "اطلب العلم من المهد إلى اللحد",
      "من صبر ظفر"
    ];

    // ================ Toast System ================
    const toast = {
      /**
       * @param {Object} config
       * @param {string} config.title
       * @param {string} config.description
       * @param {'default'|'destructive'} config.variant
       */
      show: function(config) {
        const toastContainer = document.getElementById('toast-container');
        
        const toastElement = document.createElement('div');
        toastElement.className = `toast ${config.variant === 'destructive' ? 'toast-error' : 'toast-success'}`;
        
        const content = document.createElement('div');
        content.className = 'toast-content';
        
        const title = document.createElement('div');
        title.className = 'toast-title';
        title.textContent = config.title;
        
        const message = document.createElement('div');
        message.className = 'toast-message';
        message.textContent = config.description;
        
        content.appendChild(title);
        content.appendChild(message);
        toastElement.appendChild(content);
        
        toastContainer.appendChild(toastElement);
        
        setTimeout(() => {
          toastElement.style.opacity = '0';
          toastElement.style.transform = 'translateY(-20px)';
          
          setTimeout(() => {
            toastContainer.removeChild(toastElement);
          }, 300);
        }, 3000);
      }
    };

    // ================ Utility Functions ================
    /**
     * Updates the progress bar during loading operations
     * @param {boolean} isLoading - Whether loading is in progress
     */
    function updateProgress(isLoading) {
      if (state.progressInterval) {
        clearInterval(state.progressInterval);
        state.progressInterval = null;
      }
      
      if (state.quoteInterval) {
        clearInterval(state.quoteInterval);
        state.quoteInterval = null;
      }
      
      if (isLoading) {
        state.progress = 0;
        state.progressText = "جاري التحميل...";
        updateProgressBar();
        
        let index = 0;
        state.wisdomQuote = wisdomQuotes[0];
        
        state.quoteInterval = setInterval(() => {
          index = (index + 1) % wisdomQuotes.length;
          state.wisdomQuote = wisdomQuotes[index];
          updateWisdomQuote();
        }, 3000);
        
        state.progressInterval = setInterval(() => {
          if (state.progress >= 90) {
            clearInterval(state.progressInterval);
            state.progressInterval = null;
            return;
          }
          
          const nextStep = state.progress + (10 - state.progress / 10);
          
          // Update progress text based on progress value
          if (nextStep > 75) {
            state.progressText = "جاري إنشاء الملفات...";
          } else if (nextStep > 50) {
            state.progressText = "جاري معالجة البيانات...";
          } else if (nextStep > 25) {
            state.progressText = "جاري التحقق من المعلومات...";
          }
          
          state.progress = nextStep;
          updateProgressBar();
        }, 300);
      } else {
        state.progress = 100;
        updateProgressBar();
        
        // Reset progress after animation completes
        setTimeout(() => {
          state.progress = 0;
          state.progressText = "";
          state.wisdomQuote = "";
          updateProgressBar();
          updateWisdomQuote();
        }, 500);
      }
    }

    /**
     * Updates the progress bar UI
     */
    function updateProgressBar() {
      const progressContainer = document.getElementById('progress-container');
      if (!progressContainer) return;
      
      const progressText = progressContainer.querySelector('.progress-text');
      const progressValue = progressContainer.querySelector('.progress-value');
      const progressBar = progressContainer.querySelector('.progress-bar');
      
      if (progressText) progressText.textContent = state.progressText;
      if (progressValue) progressValue.textContent = Math.round(state.progress) + '%';
      if (progressBar) progressBar.style.width = `${state.progress}%`;
    }

    /**
     * Updates the wisdom quote UI
     */
    function updateWisdomQuote() {
      const quoteElement = document.getElementById('wisdom-quote');
      if (quoteElement) {
        quoteElement.textContent = state.wisdomQuote;
        quoteElement.style.display = state.wisdomQuote ? 'block' : 'none';
      }
    }

    /**
     * Toggles dark mode
     */
    function toggleDarkMode() {
      state.isDarkMode = !state.isDarkMode;
      document.body.classList.toggle('dark', state.isDarkMode);
      
      // Initialize particles with new color
      initializeParticles(state.isDarkMode);
      
      // Re-render the UI with new theme
      renderApp();
    }

    /**
     * Initializes particles.js background
     * @param {boolean} isDarkMode - Whether dark mode is enabled
     */
    function initializeParticles(isDarkMode) {
      if (window.particlesJS) {
        window.particlesJS('particles', {
          particles: {
            number: { value: 80 },
            color: { value: isDarkMode ? '#ffffff' : '#6366f1' },
            opacity: { value: 0.2 },
            size: { value: 3 },
            move: {
              enable: true,
              speed: 1,
              direction: "none",
              random: true,
              straight: false,
              out_mode: "out",
              bounce: false,
            },
            line_linked: {
              enable: true,
              distance: 150,
              color: isDarkMode ? '#ffffff' : '#6366f1',
              opacity: 0.1,
              width: 1
            },
          },
          interactivity: {
            detect_on: "canvas",
            events: {
              onhover: {
                enable: true,
                mode: "grab"
              },
              resize: true
            },
          },
        });
      }
    }

    /**
     * Function to get available tabs based on PDF results
     * @param {PDFResult|null} pdfs - The PDF results object
     * @returns {string[]} - Array of available tab keys
     */
    function getAvailableTabs(pdfs) {
      if (!pdfs) return [];
      
      const tabs = [];
      if (pdfs.pdf1) tabs.push("pdf1");
      if (pdfs.pdf2) tabs.push("pdf2");
      if (pdfs.pdf3) tabs.push("pdf3");
      
      return tabs;
    }

    /**
     * Function to get tab name based on tab key
     * @param {string} tabKey - The tab key
     * @returns {string} - The display name for the tab
     */
    function getTabName(tabKey) {
      switch (tabKey) {
        case "pdf1": return "الشهادة";
        case "pdf2": return "البطاقة";
        case "pdf3": return "شهادة اللجان";
        default: return "";
      }
    }

    /**
     * Downloads a PDF file
     * @param {string} url - The URL of the PDF to download
     * @param {string} filename - The name to save the file as
     */
    function downloadPDF(url, filename) {
      const link = document.createElement('a');
      link.href = url;
      link.setAttribute('download', filename);
      link.setAttribute('target', '_blank');
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // ================ Form Handlers ================
    /**
     * Handles the key validation step
     */
    async function validateKeyHandler() {
      if (!state.accessKey.trim()) {
        state.errorMsg = "الرجاء إدخال مفتاح الوصول";
        renderKeyStep();
        return;
      }

      state.isLoading = true;
      state.errorMsg = "";
      state.progressText = "جاري التحقق من المفتاح...";
      updateProgress(true);
      renderKeyStep();
      
      try {
        // Call Google Apps Script function
        google.script.run
          .withSuccessHandler(response => {
            if (response.isValid) {
              state.userRank = response.rank;
              state.isKeyUsed = response.used;
              state.previousFiles = response.previousFiles || [];
              
              // If the key has been used (except for قائد) and there are previous files,
              // go directly to result section with those files
              if (response.used && response.previousFiles && response.previousFiles.length > 0) {
                // Find the most recent submission for this key
                const latestSubmission = response.previousFiles[0];
                state.results = {
                  pdf1: latestSubmission.pdf1,
                  pdf2: latestSubmission.pdf2,
                  pdf3: latestSubmission.pdf3
                };
                state.fullName = latestSubmission.name;
                state.currentStep = "result";
                toast.show({
                  title: "تم التعرف عليك",
                  description: "تم استرجاع بياناتك السابقة بنجاح",
                  variant: "default"
                });
              } else {
                // Proceed to form for new submission
                state.currentStep = "form";
              }
              
              state.isLoading = false;
              updateProgress(false);
              renderApp();
            } else {
              state.errorMsg = "المفتاح غير صحيح";
              state.isLoading = false;
              updateProgress(false);
              renderKeyStep();
            }
          })
          .withFailureHandler(err => {
            state.errorMsg = err.message || "حدث خطأ، الرجاء المحاولة لاحقًا";
            state.isLoading = false;
            updateProgress(false);
            renderKeyStep();
          })
          .validateKey(state.accessKey);
      } catch (err) {
        state.errorMsg = err.message || "حدث خطأ، الرجاء المحاولة لاحقًا";
        state.isLoading = false;
        updateProgress(false);
        renderKeyStep();
      }
    }

    /**
     * Handles photo selection and preview
     * @param {Event} e - The change event
     */
    function handlePhotoChange(e) {
      const fileInput = e.target;
      if (!fileInput.files || !fileInput.files[0]) return;
      
      const file = fileInput.files[0];
      
      // Validate file type
      const allowedTypes = ['image/jpeg', 'image/png', 'image/jpg'];
      if (!allowedTypes.includes(file.type)) {
        toast.show({
          title: "نوع الملف غير مدعوم",
          description: "يرجى اختيار صورة بصيغة PNG أو JPEG",
          variant: "destructive"
        });
        return;
      }

      // Validate file size (max 20MB)
      if (file.size > 20 * 1024 * 1024) {
        toast.show({
          title: "حجم الصورة كبير جداً",
          description: "الحد الأقصى المسموح به هو 20 ميجابايت",
          variant: "destructive"
        });
        return;
      }

      state.photoFile = file;

      // Create preview
      const reader = new FileReader();
      reader.onload = (e) => {
        state.photoPreview = e.target.result;
        renderFormStep();
      };
      reader.readAsDataURL(file);
    }

    /**
     * Submits the form with data and photo
     */
    async function submitForm() {
      // Form validation based on user rank
      if (!state.fullName.trim()) {
        toast.show({
          title: "خطأ",
          description: "الرجاء إدخال الاسم الكامل",
          variant: "destructive"
        });
        return;
      }

      // Rank-specific validations
      if ((state.userRank === "كشاف" || state.userRank === "قائد")) {
        if (!state.photoFile) {
          toast.show({
            title: "خطأ",
            description: "الرجاء اختيار صورة",
            variant: "destructive"
          });
          return;
        }

        if (!state.teamNumber.trim()) {
          toast.show({
            title: "خطأ",
            description: "الرجاء إدخال رقم الفرقة",
            variant: "destructive"
          });
          return;
        }

        if (!state.serialNumber.trim()) {
          toast.show({
            title: "خطأ", 
            description: "الرجاء إدخال الرقم التسلسلي",
            variant: "destructive"
          });
          return;
        }
      }

      if (state.userRank === "قائد" && !state.gender) {
        toast.show({
          title: "خطأ",
          description: "الرجاء اختيار النوع",
          variant: "destructive"
        });
        return;
      }

      state.isLoading = true;
      updateProgress(true);
      renderFormStep();
      
      try {
        // Prepare form data based on user rank
        const formData = {
          name: state.fullName,
          key: state.accessKey,
          rank: state.userRank,
        };
        
        // Add rank-specific fields
        if (state.userRank === "قائد" || state.userRank === "كشاف") {
          formData.teamNumber = state.teamNumber;
          formData.serialNumber = state.serialNumber;
        }
        
        if (state.userRank === "قائد") {
          formData.gender = state.gender;
        }

        // Add photo if provided
        if (state.photoFile) {
          // Convert the photo to base64
          const base64String = await new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => {
              resolve(e.target.result);
            };
            reader.readAsDataURL(state.photoFile);
          });

          formData.base64Image = base64String;
          formData.mimeType = state.photoFile.type;
        }

        // Process form data using Google Apps Script
        google.script.run
          .withSuccessHandler(response => {
            if (response) {
              state.results = response;
              state.currentStep = "result";
              toast.show({
                title: "نجاح",
                description: "تم إنشاء الملفات بنجاح",
                variant: "default"
              });
              
              state.isLoading = false;
              updateProgress(false);
              renderApp();
            }
          })
          .withFailureHandler(error => {
            toast.show({
              title: "خطأ",
              description: error.message || "حدث خطأ أثناء معالجة الطلب",
              variant: "destructive"
            });
            
            state.isLoading = false;
            updateProgress(false);
            renderFormStep();
          })
          .processFormWithImage(formData);
      } catch (error) {
        toast.show({
          title: "خطأ",
          description: error.message || "حدث خطأ أثناء معالجة الطلب",
          variant: "destructive"
        });
        
        state.isLoading = false;
        updateProgress(false);
        renderFormStep();
      }
    }

    /**
     * Resets the application state
     */
    function restartProcess() {
      // Reload the page to completely reset the state
      window.location.reload();
    }

    // ================ UI Rendering Functions ================
    /**
     * Renders the main application
     */
    function renderApp() {
      const appContainer = document.getElementById('app');
      
      // Start with a clean app container
      appContainer.innerHTML = '';
      
      // Add dark mode toggle button
      const darkModeButton = document.createElement('button');
      darkModeButton.className = 'fixed top-4 right-4 p-2 rounded-full bg-opacity-20 backdrop-blur-sm z-50 transition-all hover:bg-opacity-30';
      darkModeButton.setAttribute('aria-label', state.isDarkMode ? 'تفعيل الوضع النهاري' : 'تفعيل الوضع الليلي');
      darkModeButton.onclick = toggleDarkMode;
      
      if (state.isDarkMode) {
        darkModeButton.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-300">
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
          </svg>
        `;
      } else {
        darkModeButton.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-700">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
          </svg>
        `;
      }
      
      appContainer.appendChild(darkModeButton);
      
      // Create main card container
      const cardContainer = document.createElement('div');
      cardContainer.className = `relative ${state.isDarkMode ? 'bg-gray-800/40' : 'bg-white/40'} backdrop-blur-lg border ${state.isDarkMode ? 'border-gray-700/30' : 'border-white/30'} rounded-3xl w-full max-w-md mx-auto shadow-2xl z-10 transform transition-all hover:shadow-lg overflow-hidden`;
      cardContainer.style.direction = 'rtl';
      
      // Add banner image
      const bannerDiv = document.createElement('div');
      bannerDiv.className = 'w-full h-32 relative overflow-hidden';
      bannerDiv.innerHTML = `
        <img 
          src="https://i.ibb.co/sJXfcDHM/3a4c72ac-fd79-4a6f-86d8-96031eec8209.jpg" 
          alt="Banner" 
          class="w-full h-full object-cover"
        />
        <div class="${state.isDarkMode ? 'bg-gradient-to-b from-transparent to-gray-800/40' : 'bg-gradient-to-b from-transparent to-white/40'} absolute inset-0"></div>
      `;
      cardContainer.appendChild(bannerDiv);
      
      // Content container
      const contentDiv = document.createElement('div');
      contentDiv.className = 'p-8 md:p-10';
      
      // Progress bar for loading states
      if (state.isLoading) {
        const progressDiv = document.createElement('div');
        progressDiv.id = 'progress-container';
        progressDiv.className = 'mb-6 space-y-4 animate-fade-in';
        progressDiv.innerHTML = `
          <div class="flex justify-between text-sm font-medium">
            <span class="${state.isDarkMode ? 'text-gray-300' : 'text-gray-600'} progress-text">${state.progressText}</span>
            <span class="${state.isDarkMode ? 'text-indigo-300' : 'text-indigo-600'} progress-value">${Math.round(state.progress)}%</span>
          </div>
          <div class="progress">
            <div class="progress-bar" style="width: ${state.progress}%"></div>
          </div>
          <div id="wisdom-quote" class="${state.isDarkMode ? 'text-gray-400' : 'text-gray-600'} text-center text-sm italic animate-fade-in" style="display: ${state.wisdomQuote ? 'block' : 'none'}">
            ${state.wisdomQuote}
          </div>
        `;
        contentDiv.appendChild(progressDiv);
      }
      
      // Render the appropriate step
      if (state.currentStep === "key") {
        renderKeyStepContent(contentDiv);
      } else if (state.currentStep === "form") {
        renderFormStepContent(contentDiv);
      } else if (state.currentStep === "result") {
        renderResultStepContent(contentDiv);
      }
      
      cardContainer.appendChild(contentDiv);
      appContainer.appendChild(cardContainer);
    }

    /**
     * Renders just the key step without rebuilding the whole UI
     */
    function renderKeyStep() {
      const contentDiv = document.querySelector('#app > div > div:last-child');
      if (contentDiv) {
        contentDiv.innerHTML = '';
        
        // Add progress bar if loading
        if (state.isLoading) {
          const progressDiv = document.createElement('div');
          progressDiv.id = 'progress-container';
          progressDiv.className = 'mb-6 space-y-4 animate-fade-in';
          progressDiv.innerHTML = `
            <div class="flex justify-between text-sm font-medium">
              <span class="${state.isDarkMode ? 'text-gray-300' : 'text-gray-600'} progress-text">${state.progressText}</span>
              <span class="${state.isDarkMode ? 'text-indigo-300' : 'text-indigo-600'} progress-value">${Math.round(state.progress)}%</span>
            </div>
            <div class="progress">
              <div class="progress-bar" style="width: ${state.progress}%"></div>
            </div>
            <div id="wisdom-quote" class="${state.isDarkMode ? 'text-gray-400' : 'text-gray-600'} text-center text-sm italic animate-fade-in" style="display: ${state.wisdomQuote ? 'block' : 'none'}">
              ${state.wisdomQuote}
            </div>
          `;
          contentDiv.appendChild(progressDiv);
        }
        
        renderKeyStepContent(contentDiv);
      } else {
        renderApp();
      }
    }

    /**
     * Renders the key step content
     * @param {HTMLElement} container - The container to append content to
     */
    function renderKeyStepContent(container) {
      const keyStepDiv = document.createElement('div');
      keyStepDiv.className = 'space-y-6 animate-fade-in';
      
      keyStepDiv.innerHTML = `
        <h1 class="${state.isDarkMode ? 'text-indigo-300' : 'text-indigo-600'} text-3xl font-bold text-center mb-8">
          مرحبًا بك في نظام التسجيل
        </h1>
        
        <div class="space-y-4">
          <input
            type="text"
            value="${state.accessKey}"
            id="access-key-input"
            placeholder="أدخل مفتاح الوصول"
            class="w-full px-4 py-3 rounded-lg ${state.isDarkMode ? 'bg-gray-700 text-white border-gray-600' : 'bg-white text-gray-700 border-gray-200'} border focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all"
            ${state.isLoading ? 'disabled readonly' : ''}
          />
          
          <button
            id="validate-key-button"
            class="w-full py-3 rounded-lg font-bold transition-all ${
              state.isLoading 
                ? 'opacity-70 cursor-not-allowed' 
                : 'hover:shadow-lg transform hover:-translate-y-0.5'
            } ${state.isDarkMode 
                ? 'bg-gradient-to-r from-indigo-600 to-purple-600 text-white' 
                : 'bg-gradient-to-r from-indigo-500 to-purple-500 text-white'
            }"
            ${state.isLoading ? 'disabled' : ''}
          >
            ${state.isLoading ? "جاري التحقق..." : "تأكيد المفتاح"}
          </button>
          
          ${state.errorMsg ? `
            <div class="text-red-500 bg-red-100 border border-red-200 rounded-lg p-3 text-sm">
              ${state.errorMsg}
            </div>
          ` : ''}
        </div>
      `;
      
      container.appendChild(keyStepDiv);
      
      // Add event listeners
      document.getElementById('access-key-input').addEventListener('input', (e) => {
        state.accessKey = e.target.value;
      });
      
      document.getElementById('validate-key-button').addEventListener('click', validateKeyHandler);
    }

    /**
     * Renders just the form step without rebuilding the whole UI
     */
    function renderFormStep() {
      const contentDiv = document.querySelector('#app > div > div:last-child');
      if (contentDiv) {
        contentDiv.innerHTML = '';
        
        // Add progress bar if loading
        if (state.isLoading) {
          const progressDiv = document.createElement('div');
          progressDiv.id = 'progress-container';
          progressDiv.className = 'mb-6 space-y-4 animate-fade-in';
          progressDiv.innerHTML = `
            <div class="flex justify-between text-sm font-medium">
              <span class="${state.isDarkMode ? 'text-gray-300' : 'text-gray-600'} progress-text">${state.progressText}</span>
              <span class="${state.isDarkMode ? 'text-indigo-300' : 'text-indigo-600'} progress-value">${Math.round(state.progress)}%</span>
            </div>
            <div class="progress">
              <div class="progress-bar" style="width: ${state.progress}%"></div>
            </div>
            <div id="wisdom-quote" class="${state.isDarkMode ? 'text-gray-400' : 'text-gray-600'} text-center text-sm italic animate-fade-in" style="display: ${state.wisdomQuote ? 'block' : 'none'}">
              ${state.wisdomQuote}
            </div>
          `;
          contentDiv.appendChild(progressDiv);
        }
        
        renderFormStepContent(contentDiv);
      } else {
        renderApp();
      }
    }

    /**
     * Renders the form step content
     * @param {HTMLElement} container - The container to append content to
     */
    function renderFormStepContent(container) {
      const formStepDiv = document.createElement('div');
      formStepDiv.className = 'space-y-6 animate-fade-in';
      formStepDiv.setAttribute('data-section', 'form');
      formStepDiv.setAttribute('data-allowed', 'true');
      
      formStepDiv.innerHTML = `
        <h2 class="${state.isDarkMode ? 'text-red-400' : 'text-red-500'} text-2xl font-bold text-center">
          استمارة التسجيل
        </h2>
        
        <div class="space-y-4">
          <input
            type="text"
            id="full-name-input"
            value="${state.fullName}"
            placeholder="الاسم الكامل"
            class="w-full px-4 py-3 rounded-lg ${state.isDarkMode ? 'bg-gray-700 text-white border-gray-600' : 'bg-white text-gray-700 border-gray-200'} border focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all"
            ${state.isLoading ? 'disabled readonly' : ''}
          />

          ${(state.userRank === "كشاف" || state.userRank === "قائد") ? `
            <div class="grid grid-cols-2 gap-4">
              <input
                type="text"
                id="team-number-input"
                value="${state.teamNumber}"
                placeholder="رقم الفرقة"
                class="px-4 py-3 rounded-lg ${state.isDarkMode ? 'bg-gray-700 text-white border-gray-600' : 'bg-white text-gray-700 border-gray-200'} border focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all"
                ${state.isLoading ? 'disabled readonly' : ''}
              />
              <input
                type="text"
                id="serial-number-input"
                value="${state.serialNumber}"
                placeholder="الرقم التسلسلي"
                class="px-4 py-3 rounded-lg ${state.isDarkMode ? 'bg-gray-700 text-white border-gray-600' : 'bg-white text-gray-700 border-gray-200'} border focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all"
                ${state.isLoading ? 'disabled readonly' : ''}
              />
            </div>
            
            <div 
              id="photo-uploader"
              class="relative cursor-pointer border-2 border-dashed rounded-xl p-6 flex flex-col items-center justify-center transition-all ${
                state.isDarkMode 
                  ? 'border-gray-600 hover:border-indigo-400 bg-gray-800/50' 
                  : 'border-gray-300 hover:border-indigo-400 bg-gray-50/80'
              } ${state.photoPreview ? 'h-56' : 'h-36'}"
            >
              <input
                type="file"
                id="photo-input"
                accept="image/*"
                class="hidden"
                ${state.isLoading ? 'disabled' : ''}
              />
              
              ${state.photoPreview ? `
                <div class="relative w-full h-full">
                  <img 
                    src="${state.photoPreview}" 
                    alt="معاينة الصورة" 
                    class="w-full h-full object-contain rounded"
                  />
                  <div class="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity rounded">
                    <div class="text-white text-center">
                      <p>انقر لتغيير الصورة</p>
                    </div>
                  </div>
                </div>
              ` : `
                <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mb-2 ${state.isDarkMode ? 'text-gray-400' : 'text-gray-500'}">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                  <circle cx="8.5" cy="8.5" r="1.5"></circle>
                  <polyline points="21 15 16 10 5 21"></polyline>
                </svg>
                <span class="text-sm ${state.isDarkMode ? 'text-gray-300' : 'text-gray-600'}">انقر لاختيار صورة</span>
                <span class="text-xs mt-1 ${state.isDarkMode ? 'text-gray-400' : 'text-gray-500'}">يجب أن لا يتجاوز حجم الصورة 20 ميجابايت</span>
              `}
            </div>
          ` : ''}

          ${state.userRank === "قائد" ? `
            <div class="flex gap-4">
              <label class="flex-1 flex items-center justify-center gap-2 p-3 border rounded-lg cursor-pointer transition-all ${
                state.gender === "قائد" 
                  ? (state.isDarkMode ? 'bg-indigo-700/60 border-indigo-500' : 'bg-indigo-100 border-indigo-400') 
                  : (state.isDarkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-200')
              }">
                <input
                  type="radio"
                  name="gender"
                  value="قائد"
                  ${state.gender === "قائد" ? 'checked' : ''}
                  id="gender-male"
                  class="hidden"
                  ${state.isLoading ? 'disabled' : ''}
                />
                <span class="${state.gender === "قائد" ? (state.isDarkMode ? 'text-indigo-200' : 'text-indigo-700') : (state.isDarkMode ? 'text-gray-300' : '')}">قائد</span>
              </label>
              
              <label class="flex-1 flex items-center justify-center gap-2 p-3 border rounded-lg cursor-pointer transition-all ${
                state.gender === "قائدة" 
                  ? (state.isDarkMode ? 'bg-indigo-700/60 border-indigo-500' : 'bg-indigo-100 border-indigo-400') 
                  : (state.isDarkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-200')
              }">
                <input
                  type="radio"
                  name="gender"
                  value="قائدة"
                  ${state.gender === "قائدة" ? 'checked' : ''}
                  id="gender-female"
                  class="hidden"
                  ${state.isLoading ? 'disabled' : ''}
                />
                <span class="${state.gender === "قائدة" ? (state.isDarkMode ? 'text-indigo-200' : 'text-indigo-700') : (state.isDarkMode ? 'text-gray-300' : '')}">قائدة</span>
              </label>
            </div>
          ` : ''}
          
          <button
            id="submit-form-button"
            class="w-full py-3 rounded-lg font-bold transition-all ${
              state.isLoading 
                ? 'opacity-70 cursor-not-allowed' 
                : 'hover:shadow-lg transform hover:-translate-y-0.5'
            } ${state.isDarkMode 
                ? 'bg-gradient-to-r from-green-600 to-emerald-600 text-white' 
                : 'bg-gradient-to-r from-green-500 to-emerald-500 text-white'
            }"
            ${state.isLoading ? 'disabled' : ''}
          >
            ${state.isLoading ? "جاري المعالجة..." : "إرسال البيانات"}
          </button>

          ${state.userRank === "قائد" && state.previousFiles.length > 0 ? renderFileHistoryCollapsible() : ''}
        </div>
      `;
      
      container.appendChild(formStepDiv);
      
      // Add event listeners
      document.getElementById('full-name-input')?.addEventListener('input', (e) => {
        state.fullName = e.target.value;
      });
      
      document.getElementById('team-number-input')?.addEventListener('input', (e) => {
        state.teamNumber = e.target.value;
      });
      
      document.getElementById('serial-number-input')?.addEventListener('input', (e) => {
        state.serialNumber = e.target.value;
      });
      
      document.getElementById('gender-male')?.addEventListener('change', () => {
        state.gender = "قائد";
        renderFormStep();
      });
      
      document.getElementById('gender-female')?.addEventListener('change', () => {
        state.gender = "قائدة";
        renderFormStep();
      });
      
      document.getElementById('photo-uploader')?.addEventListener('click', () => {
        document.getElementById('photo-input').click();
      });
      
      document.getElementById('photo-input')?.addEventListener('change', handlePhotoChange);
      
      document.getElementById('submit-form-button')?.addEventListener('click', submitForm);
      
      // Add collapsible event listeners if applicable
      const collapsibleTrigger = document.querySelector('.collapsible-trigger');
      if (collapsibleTrigger) {
        collapsibleTrigger.addEventListener('click', () => {
          state.isCollapsibleOpen = !state.isCollapsibleOpen;
          const content = document.querySelector('.collapsible-content');
          const chevron = document.querySelector('.chevron-down');
          
          if (state.isCollapsibleOpen) {
            content.style.height = content.scrollHeight + 'px';
            content.setAttribute('data-state', 'open');
            chevron.classList.add('rotate-180');
          } else {
            content.style.height = '0';
            content.setAttribute('data-state', 'closed');
            chevron.classList.remove('rotate-180');
          }
        });
      }
    }

    /**
     * Renders the file history collapsible component
     * @returns {string} HTML string for the collapsible component
     */
    function renderFileHistoryCollapsible() {
      const filesHtml = state.previousFiles.map((file, index) => {
        return `
          <div class="${index > 0 ? 'pt-4' : ''} ${index === 0 ? 'first:pt-0' : ''}">
            <div class="flex justify-between items-center mb-2">
              <span class="font-medium">${file.name}</span>
              <span class="text-xs ${state.isDarkMode ? 'text-gray-400' : 'text-gray-500'}">
                ${file.date}
              </span>
            </div>
            <div class="grid grid-cols-1 gap-2">
              ${file.pdf1 ? `
                <a 
                  href="${file.pdf1}" 
                  target="_blank" 
                  rel="noopener noreferrer"
                  class="text-sm flex items-center p-2 rounded ${
                    state.isDarkMode ? 'bg-gray-700 text-blue-300 hover:bg-gray-600' : 'bg-gray-100 text-blue-600 hover:bg-gray-200'
                  }"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                  </svg>
                  الشهادة
                </a>
              ` : ''}
              ${file.pdf2 ? `
                <a 
                  href="${file.pdf2}" 
                  target="_blank" 
                  rel="noopener noreferrer"
                  class="text-sm flex items-center p-2 rounded ${
                    state.isDarkMode ? 'bg-gray-700 text-purple-300 hover:bg-gray-600' : 'bg-gray-100 text-purple-600 hover:bg-gray-200'
                  }"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                  </svg>
                  البطاقة
                </a>
              ` : ''}
              ${file.pdf3 ? `
                <a 
                  href="${file.pdf3}" 
                  target="_blank" 
                  rel="noopener noreferrer"
                  class="text-sm flex items-center p-2 rounded ${
                    state.isDarkMode ? 'bg-gray-700 text-green-300 hover:bg-gray-600' : 'bg-gray-100 text-green-600 hover:bg-gray-200'
                  }"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                  </svg>
                  شهادة اللجان
                </a>
              ` : ''}
            </div>
          </div>
        `;
      }).join('');
      
      return `
        <div class="collapsible mt-4 rounded-lg overflow-hidden transition-all ${
          state.isDarkMode ? 'bg-gray-800/80 border border-gray-700' : 'bg-white/80 border border-gray-200'
        }">
          <button class="collapsible-trigger flex items-center justify-between w-full p-4 text-right">
            <span class="font-medium">سجل الملفات السابقة</span>
            <svg class="w-5 h-5 transition-transform chevron-down ${state.isCollapsibleOpen ? 'rotate-180' : ''}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </button>
          <div class="collapsible-content max-h-64 overflow-y-auto" style="height: ${state.isCollapsibleOpen ? 'auto' : '0'}" data-state="${state.isCollapsibleOpen ? 'open' : 'closed'}">
            <div class="p-4 space-y-4 divide-y divide-gray-200">
              ${filesHtml}
            </div>
          </div>
        </div>
      `;
    }

    /**
     * Renders the result step content
     * @param {HTMLElement} container - The container to append content to
     */
    function renderResultStepContent(container) {
      const resultStepDiv = document.createElement('div');
      resultStepDiv.className = 'space-y-6 animate-fade-in';
      
      resultStepDiv.innerHTML = `
        <div class="text-center">
          <h2 class="${state.isDarkMode ? 'text-green-400' : 'text-green-600'} text-xl font-bold mb-2">
            تم إنشاء الملفات بنجاح
          </h2>
          <p class="${state.isDarkMode ? 'text-gray-300' : 'text-gray-600'} mb-6">
            مرحباً بك ${state.fullName}، تم إنشاء الملفات التالية
          </p>
        </div>

        ${state.results && getAvailableTabs(state.results).length > 0 ? renderResultTabs() : `
          <div class="${state.isDarkMode ? 'border-gray-700 bg-gray-800/50' : 'border-gray-200 bg-gray-50'} text-center p-8 border rounded-lg">
            <p class="${state.isDarkMode ? 'text-gray-400' : 'text-gray-600'}">
              لم يتم إنشاء أي ملفات
            </p>
          </div>
        `}
        
        <button
          id="restart-button"
          class="w-full py-3 rounded-lg font-bold transition-all ${
            state.isDarkMode 
              ? 'bg-gradient-to-r from-purple-600 to-indigo-600 text-white' 
              : 'bg-gradient-to-r from-purple-500 to-indigo-500 text-white'
          } hover:shadow-lg transform hover:-translate-y-0.5"
        >
          العودة للبداية
        </button>
      `;
      
      container.appendChild(resultStepDiv);
      
      // Add event listeners
      document.getElementById('restart-button')?.addEventListener('click', restartProcess);
      
      // Add tab event listeners
      const tabs = getAvailableTabs(state.results);
      tabs.forEach(tab => {
        document.getElementById(`tab-${tab}`)?.addEventListener('click', () => {
          state.activeTab = tab;
          
          // Update active state for all tabs
          tabs.forEach(t => {
            const trigger = document.getElementById(`tab-${t}`);
            const content = document.getElementById(`tab-content-${t}`);
            
            if (trigger) {
              if (t === state.activeTab) {
                trigger.setAttribute('data-state', 'active');
              } else {
                trigger.setAttribute('data-state', 'inactive');
              }
            }
            
            if (content) {
              if (t === state.activeTab) {
                content.setAttribute('data-state', 'active');
              } else {
                content.setAttribute('data-state', 'inactive');
              }
            }
          });
        });
      });
      
      // Add download button event listeners
      tabs.forEach(tab => {
        const downloadButton = document.getElementById(`download-${tab}`);
        if (downloadButton) {
          downloadButton.addEventListener('click', () => {
            const pdfUrl = state.results[tab];
            const pdfFilename = `${getTabName(tab)}_${state.fullName}.pdf`;
            downloadPDF(pdfUrl, pdfFilename);
          });
        }
      });
    }

    /**
     * Renders the result tabs content
     * @returns {string} HTML string for the tabs component
     */
    function renderResultTabs() {
      const availableTabs = getAvailableTabs(state.results);
      
      // Create tab triggers
      const tabTriggers = availableTabs.map(tab => {
        return `
          <button 
            id="tab-${tab}" 
            class="tab-trigger" 
            data-state="${tab === state.activeTab ? 'active' : 'inactive'}"
          >
            ${getTabName(tab)}
          </button>
        `;
      }).join('');
      
      // Create tab content
      const tabContents = availableTabs.map(tab => {
        const pdfUrl = state.results[tab];
        const pdfFilename = `${getTabName(tab)}_${state.fullName}.pdf`;
        
        return `
          <div 
            id="tab-content-${tab}" 
            class="tab-content" 
            data-state="${tab === state.activeTab ? 'active' : 'inactive'}"
          >
            <div class="bg-gray-800 rounded-lg overflow-hidden">
              <iframe 
                src="${pdfUrl}" 
                class="w-full h-96" 
                title="${getTabName(tab)}" 
              ></iframe>
            </div>
            
            <div class="flex justify-between mt-4">
              <button
                id="download-${tab}"
                class="px-4 py-2 rounded-lg flex items-center gap-2 ${
                  state.isDarkMode 
                    ? 'bg-blue-600 hover:bg-blue-700 text-white' 
                    : 'bg-blue-500 hover:bg-blue-600 text-white'
                }"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="7 10 12 15 17 10"></polyline>
                  <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                تنزيل الملف
              </button>
              
              <a 
                href="${pdfUrl}" 
                target="_blank" 
                rel="noopener noreferrer"
                class="px-4 py-2 rounded-lg flex items-center gap-2 ${
                  state.isDarkMode 
                    ? 'bg-gray-700 hover:bg-gray-600 text-white' 
                    : 'bg-gray-200 hover:bg-gray-300 text-gray-800'
                }"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                  <polyline points="15 3 21 3 21 9"></polyline>
                  <line x1="10" y1="14" x2="21" y2="3"></line>
                </svg>
                فتح في نافذة جديدة
              </a>
            </div>
          </div>
        `;
      }).join('');
      
      return `
        <div class="tabs">
          <div class="tabs-list">
            ${tabTriggers}
          </div>
          ${tabContents}
        </div>
      `;
    }

    // ================ Initialize the App ================
    document.addEventListener('DOMContentLoaded', () => {
      // Check system preference for dark/light mode
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      state.isDarkMode = prefersDark;
      document.body.classList.toggle('dark', state.isDarkMode);
      
      // Initialize particles
      initializeParticles(state.isDarkMode);
      
      // Render the initial app state
      renderApp();
    });
  </script>
</body>
</html>
